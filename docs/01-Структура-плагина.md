# Этап 1: Структура плагина Moodle

## Введение

Локальные плагины Moodle (local plugins) позволяют расширять функциональность системы без изменения ядра. Они размещаются в директории `/local/` и могут содержать собственные страницы, функции, таблицы базы данных и многое другое.

## Базовые понятия

### Что такое локальный плагин?

Локальный плагин — это набор файлов, который:
- Размещается в директории `/local/название_плагина/`
- Имеет обязательные файлы для работы
- Может создавать таблицы в базе данных
- Может добавлять новые страницы и функции
- Интегрируется с системой Moodle через хуки и события

### Преимущества локальных плагинов

1. **Независимость от обновлений Moodle** — плагин не затрагивает ядро системы
2. **Простота установки** — достаточно скопировать файлы и выполнить обновление БД
3. **Гибкость** — можно реализовать любую функциональность
4. **Безопасность** — изменения не влияют на стабильность основной системы

## Структура директорий

### Базовая структура

```
local/deanpromoodle/
├── db/                    # Работа с базой данных
│   ├── install.xml       # Определение таблиц при установке
│   └── upgrade.php       # Логика обновления БД
├── lang/                 # Языковые файлы
│   ├── en/               # Английский язык
│   └── ru/               # Русский язык
├── pages/                # Страницы плагина
│   ├── student.php       # Страница студента
│   ├── teacher.php       # Страница преподавателя
│   └── admin.php        # Административная страница
├── access.php            # Определение прав доступа
├── lib.php               # Основные функции
├── version.php           # Метаданные плагина
└── index.php             # Защита от прямого доступа
```

## Обязательные файлы

### 1. version.php

Файл с метаданными плагина. Moodle использует его для:
- Определения версии плагина
- Проверки совместимости с версией Moodle
- Отслеживания обновлений

**Пример:**

```php
<?php
defined('MOODLE_INTERNAL') || die();

$plugin->component = 'local_deanpromoodle';
$plugin->version = 2026013007;  // Формат: YYYYMMDDXX
$plugin->requires = 2022041900; // Минимальная версия Moodle (4.0+)
$plugin->maturity = MATURITY_ALPHA; // Стадия разработки
$plugin->release = 'v1.0.0-alpha';
```

**Параметры:**
- `component` — уникальный идентификатор плагина (обязательно `local_название`)
- `version` — версия плагина в формате YYYYMMDDXX (год, месяц, день, номер версии)
- `requires` — минимальная версия Moodle, с которой работает плагин
- `maturity` — стадия разработки (`MATURITY_ALPHA`, `MATURITY_BETA`, `MATURITY_STABLE`)
- `release` — строковое представление версии для пользователей

### 2. access.php

Определяет права доступа (capabilities) для плагина.

**Пример:**

```php
<?php
defined('MOODLE_INTERNAL') || die();

$capabilities = [
    'local/deanpromoodle:viewstudent' => [
        'captype' => 'read',
        'contextlevel' => CONTEXT_SYSTEM,
        'archetypes' => [
            'student' => CAP_ALLOW,
        ],
    ],
];
```

**Параметры:**
- `captype` — тип capability (`read`, `write`)
- `contextlevel` — уровень контекста (`CONTEXT_SYSTEM`, `CONTEXT_COURSE`)
- `archetypes` — кому разрешено по умолчанию

### 3. lib.php

Содержит основные функции плагина, которые могут быть вызваны из других частей Moodle.

**Основные функции:**
- Функции навигации
- Хуки (hooks) для интеграции с Moodle
- Вспомогательные функции

**Пример:**

```php
<?php
defined('MOODLE_INTERNAL') || die();

function local_deanpromoodle_extend_navigation(global_navigation $navigation) {
    // Добавление пунктов в навигацию
}
```

### 4. index.php

Защищает директорию плагина от прямого доступа.

**Пример:**

```php
<?php
defined('MOODLE_INTERNAL') || die();

// Редирект на главную страницу
redirect(new moodle_url('/'));
```

## Опциональные файлы и директории

### db/install.xml

Определяет структуру таблиц базы данных, которые будут созданы при установке плагина.

**Основные элементы:**
- `<TABLE>` — определение таблицы
- `<FIELD>` — определение поля
- `<KEY>` — определение ключей (primary, foreign)
- `<INDEX>` — определение индексов

### db/upgrade.php

Содержит логику обновления базы данных при обновлении плагина.

**Пример:**

```php
function xmldb_local_deanpromoodle_upgrade($oldversion) {
    global $DB;
    $dbman = $DB->get_manager();
    
    // Создание таблицы для форумов "не требует ответа"
    if ($oldversion < 2026013007) {
        $table = new xmldb_table('local_deanpromoodle_forum_no_reply');
        
        // Добавляем таблицу, если её нет
        if (!$dbman->table_exists($table)) {
            // Определение полей
            $table->add_field('id', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, XMLDB_SEQUENCE, null);
            $table->add_field('postid', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);
            $table->add_field('userid', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);
            $table->add_field('timecreated', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, '0');
            
            // Определение ключей
            $table->add_key('primary', XMLDB_KEY_PRIMARY, ['id']);
            $table->add_key('postid_fk', XMLDB_KEY_FOREIGN, ['postid'], 'forum_posts', ['id']);
            $table->add_key('userid_fk', XMLDB_KEY_FOREIGN, ['userid'], 'user', ['id']);
            $table->add_key('postuser', XMLDB_KEY_UNIQUE, ['postid', 'userid']);
            
            // Создание таблицы
            $dbman->create_table($table);
        }
        
        // Сохранение точки обновления
        upgrade_plugin_savepoint(true, 2026013007, 'local', 'deanpromoodle');
    }
    
    return true;
}
```

### lang/

Директория с языковыми файлами. Каждый язык имеет свою поддиректорию.

**Структура:**
```
lang/
├── en/
│   └── local_deanpromoodle.php
└── ru/
    └── local_deanpromoodle.php
```

**Формат языкового файла:**

```php
<?php
$string['pluginname'] = 'Dean Pro Moodle';
$string['studentpage'] = 'Student Page';
```

### pages/

Директория со страницами плагина. Каждая страница — отдельный PHP файл.

**Особенности:**
- Страницы должны загружать `config.php` Moodle
- Используют Moodle API для работы с данными
- Могут использовать шаблоны и компоненты Moodle

## Именование файлов и директорий

### Правила именования

1. **Директория плагина**: только строчные буквы, без пробелов
   - ✅ Правильно: `deanpromoodle`
   - ❌ Неправильно: `DeanProMoodle`, `dean-pro-moodle`

2. **Имена файлов**: строчные буквы, подчеркивания для разделения
   - ✅ Правильно: `admin_ajax.php`
   - ❌ Неправильно: `adminAjax.php`, `admin-ajax.php`

3. **Имена функций**: префикс `local_названиеплагина_`
   - ✅ Правильно: `local_deanpromoodle_before_footer()`
   - ❌ Неправильно: `deanpromoodle_before_footer()`

## Регистрация плагина в Moodle

После создания структуры плагина Moodle автоматически обнаружит его при:

1. **Первом запуске** после копирования файлов
2. **Обновлении** через веб-интерфейс (`/admin/index.php`)
3. **CLI обновлении**: `php admin/cli/upgrade.php`

Moodle проверяет:
- Наличие файла `version.php`
- Корректность структуры директорий
- Совместимость версий

## Проверка структуры

### Чек-лист для проверки

- [ ] Создана директория `/local/название_плагина/`
- [ ] Создан файл `version.php` с корректными метаданными
- [ ] Создан файл `access.php` с определениями capabilities
- [ ] Создан файл `lib.php` (может быть пустым на начальном этапе)
- [ ] Создан файл `index.php` для защиты директории
- [ ] Создана директория `lang/` с хотя бы одним языковым файлом
- [ ] Все имена файлов и директорий в нижнем регистре

## Следующие шаги

После создания базовой структуры переходите к:
- [Этап 2: Создание базовой структуры](02-Создание-базовой-структуры.md) — детальное создание каждого файла
- [Этап 3: Работа с базой данных](03-Работа-с-базой-данных.md) — создание таблиц

## Полезные ссылки

- [Moodle Developer Documentation](https://docs.moodle.org/dev/)
- [Moodle Plugin Development](https://docs.moodle.org/dev/Plugin_files)
- [Moodle Coding Guidelines](https://docs.moodle.org/dev/Coding_style)
