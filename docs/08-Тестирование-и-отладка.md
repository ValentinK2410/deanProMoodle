# Этап 8: Тестирование и отладка

## Введение

Тестирование и отладка — критически важные этапы разработки плагина. Правильное тестирование помогает выявить ошибки на ранних стадиях и обеспечить стабильную работу плагина.

## Включение режима отладки

### Настройка config.php

Для разработки включите режим отладки в `config.php`:

```php
// Режим отладки
$CFG->debug = DEBUG_DEVELOPER;
$CFG->debugdisplay = 1;
$CFG->debugstringids = 1;

// Отображение ошибок
ini_set('display_errors', '1');
error_reporting(E_ALL);
```

**Уровни отладки:**
- `DEBUG_NONE` — отключена
- `DEBUG_MINIMAL` — минимальная
- `DEBUG_NORMAL` — нормальная
- `DEBUG_ALL` — полная
- `DEBUG_DEVELOPER` — для разработки (максимальная детализация)

**Важно:** Не включайте режим отладки на продакшн сервере!

## Работа с логами

### Просмотр логов Moodle

Логи Moodle находятся в `/moodledata/error.log`:

```bash
# Просмотр последних 100 строк
tail -n 100 /path/to/moodledata/error.log

# Поиск ошибок
grep "ERROR" /path/to/moodledata/error.log

# Мониторинг в реальном времени
tail -f /path/to/moodledata/error.log
```

### Запись в лог

```php
// Запись отладочной информации
error_log('Debug: User ID = ' . $USER->id);
error_log('Debug: Course ID = ' . $courseid);

// Запись с контекстом
error_log('Debug: ' . print_r($data, true));
```

### Использование debugging()

```php
// Простое сообщение
debugging('This is a debug message', DEBUG_NORMAL);

// Сообщение с данными
debugging('User data: ' . print_r($user, true), DEBUG_DEVELOPER);

// Сообщение только в режиме разработки
if (debugging('', DEBUG_DEVELOPER)) {
    debugging('Detailed debug info', DEBUG_DEVELOPER);
}
```

## Отладка SQL запросов

### Включение отладки SQL

```php
// Включение отладки SQL запросов
$CFG->debug = DEBUG_DEVELOPER;
$CFG->debugdb = true;
```

### Просмотр SQL запросов

```php
global $DB;

// Включение отладки для конкретного запроса
$DB->set_debug(true);

// Выполнение запроса
$records = $DB->get_records('local_deanpromoodle_subjects');

// Отключение отладки
$DB->set_debug(false);
```

### Логирование SQL запросов

```php
global $DB;

// Получение последнего SQL запроса
$lastquery = $DB->last_query;

// Логирование
error_log('SQL Query: ' . $lastquery);
error_log('SQL Params: ' . print_r($params, true));
```

## Отладка JavaScript

### Использование console.log()

```javascript
// Простое логирование
console.log('Debug: Button clicked');

// Логирование объектов
console.log('User data:', userData);

// Логирование с меткой
console.log('[DeanProMoodle] Debug:', data);
```

### Использование console.error()

```javascript
try {
    // Код, который может вызвать ошибку
    processData(data);
} catch (error) {
    console.error('Error processing data:', error);
    console.error('Stack trace:', error.stack);
}
```

### Отладка AJAX запросов

```javascript
fetch('/local/deanpromoodle/pages/admin_ajax.php?action=searchstudents&studentname=' + query)
    .then(response => {
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        // Обработка данных
    })
    .catch(error => {
        console.error('AJAX Error:', error);
    });
```

## Проверка прав доступа

### Тестирование capabilities

```php
// Проверка прав доступа
$context = context_system::instance();

if (has_capability('local/deanpromoodle:viewstudent', $context)) {
    debugging('User has viewstudent capability', DEBUG_NORMAL);
} else {
    debugging('User does NOT have viewstudent capability', DEBUG_NORMAL);
}

// Получение всех capabilities пользователя
$capabilities = get_user_capabilities($context, $USER->id);
debugging('User capabilities: ' . print_r($capabilities, true), DEBUG_DEVELOPER);
```

### Тестирование ролей

```php
global $USER;

// Проверка ролей пользователя
$context = context_system::instance();
$roles = get_user_roles($context, $USER->id, false);

debugging('User roles: ' . print_r($roles, true), DEBUG_DEVELOPER);

// Проверка конкретной роли
foreach ($roles as $role) {
    if ($role->shortname == 'student') {
        debugging('User is a student', DEBUG_NORMAL);
    }
    if ($role->shortname == 'teacher') {
        debugging('User is a teacher', DEBUG_NORMAL);
    }
}
```

## Тестирование базы данных

### Проверка существования таблиц

```php
global $DB;

$dbman = $DB->get_manager();

// Проверка существования таблицы
$table = new xmldb_table('local_deanpromoodle_subjects');
if ($dbman->table_exists($table)) {
    debugging('Table exists', DEBUG_NORMAL);
} else {
    debugging('Table does NOT exist', DEBUG_NORMAL);
}

// Проверка существования поля
$field = new xmldb_field('name');
if ($dbman->field_exists($table, $field)) {
    debugging('Field exists', DEBUG_NORMAL);
} else {
    debugging('Field does NOT exist', DEBUG_NORMAL);
}
```

### Тестирование запросов

```php
global $DB;

// Тестирование простого запроса
try {
    $records = $DB->get_records('local_deanpromoodle_subjects');
    debugging('Found ' . count($records) . ' records', DEBUG_NORMAL);
} catch (Exception $e) {
    debugging('Error: ' . $e->getMessage(), DEBUG_NORMAL);
}

// Тестирование запроса с параметрами
try {
    $sql = "SELECT * FROM {local_deanpromoodle_subjects} WHERE visible = ?";
    $records = $DB->get_records_sql($sql, [1]);
    debugging('Found ' . count($records) . ' visible records', DEBUG_NORMAL);
} catch (Exception $e) {
    debugging('SQL Error: ' . $e->getMessage(), DEBUG_NORMAL);
}
```

## Тестирование страниц

### Проверка загрузки страницы

```php
// В начале страницы
try {
    require_once(__DIR__ . '/../../../config.php');
    require_login();
    
    debugging('Page loaded successfully', DEBUG_NORMAL);
} catch (Exception $e) {
    debugging('Error loading page: ' . $e->getMessage(), DEBUG_NORMAL);
    die('Error: ' . $e->getMessage());
}
```

### Тестирование параметров

```php
// Получение и проверка параметров
$tab = optional_param('tab', 'courses', PARAM_ALPHA);
$id = optional_param('id', 0, PARAM_INT);

debugging('Tab parameter: ' . $tab, DEBUG_NORMAL);
debugging('ID parameter: ' . $id, DEBUG_NORMAL);

// Валидация параметров
if (!in_array($tab, ['courses', 'programs'])) {
    debugging('Invalid tab parameter: ' . $tab, DEBUG_NORMAL);
    $tab = 'courses'; // Значение по умолчанию
}
```

## Тестирование форм

### Валидация данных формы

```php
// Обработка данных формы
if ($data = $mform->get_data()) {
    debugging('Form data received', DEBUG_NORMAL);
    debugging('Form data: ' . print_r($data, true), DEBUG_DEVELOPER);
    
    // Валидация
    if (empty($data->name)) {
        debugging('Validation error: name is empty', DEBUG_NORMAL);
        $errors[] = 'Name is required';
    }
    
    if (!empty($errors)) {
        debugging('Form validation errors: ' . print_r($errors, true), DEBUG_NORMAL);
    }
}
```

## Тестирование производительности

### Измерение времени выполнения

```php
// Начало измерения
$starttime = microtime(true);

// Выполнение кода
$courses = enrol_get_all_users_courses($USER->id);

// Конец измерения
$endtime = microtime(true);
$executiontime = ($endtime - $starttime) * 1000; // в миллисекундах

debugging('Execution time: ' . round($executiontime, 2) . ' ms', DEBUG_NORMAL);
```

### Подсчет запросов к БД

```php
global $DB;

// Сброс счетчика
$DB->perf_get_queries();

// Выполнение запросов
$courses = enrol_get_all_users_courses($USER->id);
$subjects = $DB->get_records('local_deanpromoodle_subjects');

// Получение статистики
$queries = $DB->perf_get_queries();
debugging('Database queries: ' . $queries, DEBUG_NORMAL);
```

## Очистка кэша

### Очистка кэша Moodle

```bash
# Через CLI
php admin/cli/purge_caches.php

# Или через веб-интерфейс
# Администрирование -> Разработка -> Очистить кэш
```

### Очистка кэша в коде

```php
// Очистка всех кэшей
purge_all_caches();

// Очистка кэша плагина
cache_helper::purge_by_definition('local_deanpromoodle', 'courses');
```

## Частые ошибки и решения

### Ошибка 1: "Table doesn't exist"

**Причина**: Таблица не создана в базе данных

**Решение**:
1. Проверьте `install.xml` на наличие определения таблицы
2. Выполните обновление базы данных через веб-интерфейс Moodle
3. Проверьте логи обновления

### Ошибка 2: "Capability not found"

**Причина**: Capability не определена в `access.php`

**Решение**:
1. Проверьте определение capability в `access.php`
2. Выполните обновление базы данных
3. Проверьте права доступа пользователя

### Ошибка 3: "Language string not found"

**Причина**: Строка не определена в языковом файле

**Решение**:
1. Проверьте наличие строки в `lang/ru/local_deanpromoodle.php`
2. Очистите кэш Moodle
3. Проверьте правильность имени строки

### Ошибка 4: "SQL syntax error"

**Причина**: Неправильный синтаксис SQL запроса

**Решение**:
1. Проверьте синтаксис SQL запроса
2. Используйте параметры вместо прямой подстановки
3. Проверьте использование `{table_name}` вместо `mdl_table_name`

### Ошибка 5: "Permission denied"

**Причина**: Недостаточно прав доступа

**Решение**:
1. Проверьте capabilities пользователя
2. Проверьте контекст выполнения
3. Убедитесь, что пользователь имеет необходимые роли

## Чек-лист тестирования

### Функциональное тестирование

- [ ] Все страницы загружаются без ошибок
- [ ] Навигация работает корректно
- [ ] Формы сохраняют данные правильно
- [ ] Права доступа работают как ожидается
- [ ] AJAX запросы выполняются успешно

### Тестирование безопасности

- [ ] SQL инъекции невозможны
- [ ] XSS атаки предотвращены
- [ ] CSRF защита работает
- [ ] Права доступа проверяются везде

### Тестирование производительности

- [ ] Страницы загружаются быстро
- [ ] SQL запросы оптимизированы
- [ ] Кэширование работает правильно
- [ ] Нет лишних запросов к БД

### Тестирование совместимости

- [ ] Работает в разных браузерах
- [ ] Адаптивный дизайн работает
- [ ] Совместимо с разными версиями Moodle
- [ ] Работает на разных устройствах

## Автоматизированное тестирование

### Создание unit тестов

```php
// tests/student_test.php
class local_deanpromoodle_student_testcase extends advanced_testcase {
    
    public function test_get_course_grade() {
        $this->resetAfterTest(true);
        
        // Создание тестовых данных
        $user = $this->getDataGenerator()->create_user();
        $course = $this->getDataGenerator()->create_course();
        
        // Тестирование функции
        $grade = get_course_grade($course->id, $user->id);
        
        // Проверка результата
        $this->assertNull($grade); // Оценки еще нет
    }
}
```

### Запуск тестов

```bash
# Запуск всех тестов плагина
vendor/bin/phpunit local/deanpromoodle/tests/

# Запуск конкретного теста
vendor/bin/phpunit local/deanpromoodle/tests/student_test.php
```

## Следующие шаги

После тестирования и отладки:
- Убедитесь, что все функции работают корректно
- Проверьте производительность на реальных данных
- Подготовьте документацию для пользователей
- Подготовьте плагин к релизу

## Полезные ссылки

- [Moodle Debugging](https://docs.moodle.org/dev/Debugging)
- [Moodle Testing](https://docs.moodle.org/dev/Testing)
- [Moodle Performance](https://docs.moodle.org/dev/Performance)
