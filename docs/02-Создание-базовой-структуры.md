# Этап 2: Создание базовой структуры

## Введение

На этом этапе мы создадим все необходимые файлы для базового функционирования плагина. Каждый файл имеет свою роль и должен быть создан в правильном формате.

## Шаг 1: Создание version.php

Файл `version.php` — это сердце плагина. Moodle использует его для идентификации и управления версиями.

### Полный код файла

```php
<?php
// This file is part of Moodle - http://moodle.org/
//
// Moodle is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// Moodle is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.

/**
 * Version details for local_deanpromoodle plugin.
 *
 * @package    local_deanpromoodle
 * @copyright  2026
 * @author     ValentinK2410 <https://github.com/ValentinK2410>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */

defined('MOODLE_INTERNAL') || die();

$plugin->component = 'local_deanpromoodle';
$plugin->version = 2026013007; // YYYYMMDDXX format
$plugin->requires = 2022041900; // Moodle 4.0+
$plugin->maturity = MATURITY_ALPHA;
$plugin->release = 'v1.0.0-alpha';
```

### Объяснение кода

1. **`defined('MOODLE_INTERNAL') || die();`** — защита от прямого доступа к файлу
2. **`$plugin->component`** — уникальный идентификатор (обязательно `local_название`)
3. **`$plugin->version`** — версия в формате YYYYMMDDXX (год, месяц, день, номер версии)
4. **`$plugin->requires`** — минимальная версия Moodle (2022041900 = Moodle 4.0)
5. **`$plugin->maturity`** — стадия разработки:
   - `MATURITY_ALPHA` — альфа-версия (в разработке)
   - `MATURITY_BETA` — бета-версия (тестирование)
   - `MATURITY_STABLE` — стабильная версия
6. **`$plugin->release`** — строковое представление версии для пользователей

### Важные моменты

- При каждом изменении плагина увеличивайте `version`
- Формат версии: YYYYMMDDXX (например, 2026013007 = 30 января 2026, версия 7)
- Компонент должен начинаться с `local_`

## Шаг 2: Создание access.php

Файл `access.php` определяет права доступа (capabilities) для плагина.

### Полный код файла

```php
<?php
// This file is part of Moodle - http://moodle.org/
//
// Moodle is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// Moodle is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.

/**
 * Capability definitions for local_deanpromoodle plugin.
 *
 * @package    local_deanpromoodle
 * @copyright  2026
 * @author     ValentinK2410 <https://github.com/ValentinK2410>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */

defined('MOODLE_INTERNAL') || die();

$capabilities = [
    'local/deanpromoodle:viewstudent' => [
        'captype' => 'read',
        'contextlevel' => CONTEXT_SYSTEM,
        'archetypes' => [
            'student' => CAP_ALLOW,
            'user' => CAP_ALLOW, // Allow all authenticated users as fallback
        ],
    ],
    'local/deanpromoodle:viewteacher' => [
        'captype' => 'read',
        'contextlevel' => CONTEXT_SYSTEM,
        'archetypes' => [
            'editingteacher' => CAP_ALLOW,
            'teacher' => CAP_ALLOW,
            'manager' => CAP_ALLOW,
            'user' => CAP_ALLOW,
        ],
    ],
    'local/deanpromoodle:viewadmin' => [
        'captype' => 'read',
        'contextlevel' => CONTEXT_SYSTEM,
        'archetypes' => [
            'manager' => CAP_ALLOW,
        ],
    ],
];
```

### Объяснение параметров

1. **`captype`** — тип capability:
   - `read` — чтение данных
   - `write` — запись данных

2. **`contextlevel`** — уровень контекста:
   - `CONTEXT_SYSTEM` — системный уровень (всего Moodle)
   - `CONTEXT_COURSE` — уровень курса
   - `CONTEXT_MODULE` — уровень модуля курса

3. **`archetypes`** — кому разрешено по умолчанию:
   - `student` — студенты
   - `teacher` — преподаватели
   - `editingteacher` — преподаватели с правами редактирования
   - `manager` — администраторы
   - `user` — все авторизованные пользователи

4. **Значения прав**:
   - `CAP_ALLOW` — разрешено
   - `CAP_PREVENT` — запрещено
   - `CAP_PROHIBIT` — строго запрещено

### Проверка прав в коде

#### Пример 1: Проверка прав студента

```php
// Проверка прав доступа для студента
$context = context_system::instance();

if (has_capability('local/deanpromoodle:viewstudent', $context)) {
    // Пользователь может просматривать страницу студента
    echo "Доступ разрешен для студента";
} else {
    // Доступ запрещен
    require_capability('local/deanpromoodle:viewstudent', $context);
}
```

#### Пример 2: Проверка прав преподавателя

```php
// Проверка прав доступа для преподавателя
$context = context_system::instance();

if (has_capability('local/deanpromoodle:viewteacher', $context)) {
    // Пользователь может просматривать страницу преподавателя
    echo "Доступ разрешен для преподавателя";
} else {
    // Доступ запрещен
    print_error('accessdenied', 'local_deanpromoodle');
}
```

#### Пример 3: Проверка прав администратора

```php
// Проверка прав доступа для администратора
$context = context_system::instance();

// Проверка стандартной capability Moodle для админа
$isadmin = has_capability('moodle/site:config', $context) || 
           has_capability('local/deanpromoodle:viewadmin', $context);

if ($isadmin) {
    // Пользователь является администратором
    echo "Доступ разрешен для администратора";
} else {
    // Доступ запрещен
    require_capability('local/deanpromoodle:viewadmin', $context);
}
```

#### Пример 4: Комплексная проверка ролей

```php
global $USER;

$context = context_system::instance();

// Определение ролей пользователя
$isadmin = false;
$isteacher = false;
$isstudent = false;

// Проверка администратора
$isadmin = has_capability('moodle/site:config', $context) || 
           has_capability('local/deanpromoodle:viewadmin', $context);

// Проверка преподавателя
if (!$isadmin) {
    $isteacher = has_capability('local/deanpromoodle:viewteacher', $context);
    
    // Альтернативная проверка через роли
    if (!$isteacher) {
        $roles = get_user_roles($context, $USER->id, false);
        foreach ($roles as $role) {
            if (in_array($role->shortname, ['teacher', 'editingteacher', 'coursecreator'])) {
                $isteacher = true;
                break;
            }
        }
    }
}

// Проверка студента
if (!$isadmin && !$isteacher) {
    $isstudent = has_capability('local/deanpromoodle:viewstudent', $context);
    
    // Альтернативная проверка через роли
    if (!$isstudent) {
        $roles = get_user_roles($context, $USER->id, false);
        foreach ($roles as $role) {
            if ($role->shortname == 'student') {
                $isstudent = true;
                break;
            }
        }
    }
}

// Использование проверенных ролей
if ($isadmin) {
    // Логика для администратора
    echo "Вы администратор";
} elseif ($isteacher) {
    // Логика для преподавателя
    echo "Вы преподаватель";
} elseif ($isstudent) {
    // Логика для студента
    echo "Вы студент";
} else {
    // Доступ запрещен
    print_error('accessdenied', 'local_deanpromoodle');
}
```

#### Пример 5: Проверка прав в контексте курса

```php
// Проверка прав в контексте конкретного курса
$courseid = 1;
$coursecontext = context_course::instance($courseid);

// Проверка, является ли пользователь преподавателем в этом курсе
$isteacherincourse = has_capability('mod/assign:grade', $coursecontext);

if ($isteacherincourse) {
    // Пользователь может оценивать задания в этом курсе
    echo "Вы преподаватель в курсе";
}

// Проверка, является ли пользователь студентом в этом курсе
$isstudentincourse = has_capability('mod/assign:submit', $coursecontext);

if ($isstudentincourse) {
    // Пользователь может отправлять задания в этом курсе
    echo "Вы студент в курсе";
}
```

#### Пример 6: Проверка через SQL запрос (для роли teacher с id=3)

```php
global $DB, $USER;

// Проверка, является ли пользователь преподавателем (roleid = 3) в любом курсе
$sql = "SELECT 1 FROM {role_assignments} ra
        JOIN {context} ctx ON ctx.id = ra.contextid
        WHERE ra.userid = ?
        AND ra.roleid = 3
        AND ctx.contextlevel = 50
        LIMIT 1";

$isteacher = $DB->record_exists_sql($sql, [$USER->id]);

if ($isteacher) {
    // Пользователь является преподавателем
    echo "Вы преподаватель";
}
```

## Шаг 3: Создание index.php

Файл `index.php` защищает директорию плагина от прямого доступа.

### Полный код файла

```php
<?php
// This file is part of Moodle - http://moodle.org/
//
// Moodle is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// Moodle is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.

defined('MOODLE_INTERNAL') || die();

// Редирект на главную страницу Moodle
redirect(new moodle_url('/'));
```

### Объяснение

- `defined('MOODLE_INTERNAL') || die();` — проверка, что файл загружен через Moodle
- `redirect()` — перенаправление на главную страницу
- Этот файл предотвращает просмотр структуры директории через браузер

## Шаг 4: Создание языковых файлов

### Структура директории lang/

```
lang/
├── en/
│   └── local_deanpromoodle.php
└── ru/
    └── local_deanpromoodle.php
```

### Файл lang/ru/local_deanpromoodle.php

```php
<?php
// This file is part of Moodle - http://moodle.org/
//
// Moodle is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// Moodle is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// Moodle is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.

/**
 * Языковые строки для плагина local_deanpromoodle.
 *
 * @package    local_deanpromoodle
 * @copyright  2026
 * @author     ValentinK2410 <https://github.com/ValentinK2410>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */

defined('MOODLE_INTERNAL') || die();

// Основные строки
$string['pluginname'] = 'Dean Pro Moodle';
$string['deanpromoodle'] = 'Dean Pro Moodle';

// Навигация
$string['studentpage'] = 'Страница студента';
$string['teacherpage'] = 'Страница преподавателя';
$string['adminpage'] = 'Страница администратора';

// Права доступа
$string['deanpromoodle:viewstudent'] = 'Просмотр страницы студента';
$string['deanpromoodle:viewteacher'] = 'Просмотр страницы преподавателя';
$string['deanpromoodle:viewadmin'] = 'Просмотр страницы администратора';
```

### Использование языковых строк

```php
// Получение строки
echo get_string('pluginname', 'local_deanpromoodle');

// С параметрами
echo get_string('welcome', 'local_deanpromoodle', ['name' => $user->firstname]);
```

### Правила именования строк

- Используйте понятные имена: `studentpage`, `teacherpage`
- Для capabilities: `pluginname:capabilityname`
- Избегайте сокращений, если они не очевидны

## Шаг 5: Создание lib.php

Файл `lib.php` содержит основные функции плагина.

### Базовая структура lib.php

```php
<?php
// This file is part of Moodle - http://moodle.org/
//
// Moodle is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// Moodle is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.

/**
 * Library functions for local_deanpromoodle plugin.
 *
 * @package    local_deanpromoodle
 * @copyright  2026
 * @author     ValentinK2410 <https://github.com/ValentinK2410>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */

defined('MOODLE_INTERNAL') || die();

/**
 * Extend navigation to add plugin pages.
 *
 * @param global_navigation $navigation The navigation object
 */
function local_deanpromoodle_extend_navigation(global_navigation $navigation) {
    global $PAGE, $USER;

    // Check if user is logged in
    if (!isloggedin() || isguestuser()) {
        return;
    }

    // Get the main navigation node
    $mainnode = $navigation->find('home', global_navigation::TYPE_ROOTNODE);
    
    if (!$mainnode) {
        return;
    }

    // Add Student Page if user has capability
    if (has_capability('local/deanpromoodle:viewstudent', context_system::instance())) {
        $studenturl = new moodle_url('/local/deanpromoodle/pages/student.php');
        $mainnode->add(
            get_string('studentpage', 'local_deanpromoodle'),
            $studenturl,
            navigation_node::TYPE_CUSTOM,
            null,
            'deanpromoodle_student',
            new pix_icon('i/user', '')
        );
    }
}
```

### Объяснение функции навигации

1. **`local_deanpromoodle_extend_navigation()`** — стандартная функция Moodle для расширения навигации
2. **`isloggedin()`** — проверка авторизации пользователя
3. **`isguestuser()`** — проверка, что пользователь не гость
4. **`has_capability()`** — проверка прав доступа
5. **`navigation_node::add()`** — добавление пункта в навигацию

### Именование функций

Все функции плагина должны начинаться с префикса `local_названиеплагина_`:

```php
// ✅ Правильно
function local_deanpromoodle_get_student_data() { }
function local_deanpromoodle_process_form() { }

// ❌ Неправильно
function get_student_data() { }
function deanpromoodle_process_form() { }
```

## Шаг 6: Создание директории pages/

Создайте директорию `pages/` для страниц плагина:

```bash
mkdir -p local/deanpromoodle/pages
```

### Защита директории pages/

Создайте файл `pages/.htaccess`:

```apache
# Защита от прямого доступа
<FilesMatch "\.php$">
    Require all denied
</FilesMatch>
```

Или создайте `pages/index.php`:

```php
<?php
defined('MOODLE_INTERNAL') || die();
redirect(new moodle_url('/'));
```

## Проверка базовой структуры

### Чек-лист

- [ ] Создан файл `version.php` с корректными метаданными
- [ ] Создан файл `access.php` с определениями capabilities
- [ ] Создан файл `index.php` для защиты директории
- [ ] Создан файл `lib.php` с базовыми функциями
- [ ] Создана директория `lang/ru/` с языковым файлом
- [ ] Создана директория `lang/en/` с языковым файлом
- [ ] Создана директория `pages/` для страниц
- [ ] Все файлы имеют правильные заголовки с лицензией

## Тестирование установки

1. Скопируйте плагин в `/local/deanpromoodle/`
2. Войдите в Moodle как администратор
3. Перейдите в **Уведомления** (Notifications)
4. Нажмите **"Upgrade Moodle database now"**
5. Проверьте, что плагин появился в списке установленных плагинов

## Частые ошибки

### Ошибка 1: "Plugin is missing from disk"

**Причина**: Неправильное имя директории или отсутствие `version.php`

**Решение**: Убедитесь, что:
- Директория называется точно `deanpromoodle` (без пробелов)
- Файл `version.php` существует и содержит `$plugin->component = 'local_deanpromoodle'`

### Ошибка 2: "Component name mismatch"

**Причина**: Несоответствие имени компонента в `version.php` и имени директории

**Решение**: Убедитесь, что `$plugin->component = 'local_deanpromoodle'` соответствует имени директории

### Ошибка 3: "Language string not found"

**Причина**: Отсутствует языковой файл или неправильное имя строки

**Решение**: 
- Проверьте наличие файла `lang/ru/local_deanpromoodle.php`
- Убедитесь, что строка определена в языковом файле
- Используйте правильный формат: `get_string('stringname', 'local_deanpromoodle')`

## Следующие шаги

После создания базовой структуры переходите к:
- [Этап 3: Работа с базой данных](03-Работа-с-базой-данных.md) — создание таблиц
- [Этап 4: Создание страниц](04-Создание-страниц.md) — разработка страниц плагина

## Полезные ссылки

- [Moodle Plugin Development](https://docs.moodle.org/dev/Plugin_files)
- [Moodle Capabilities](https://docs.moodle.org/dev/Access_API)
- [Moodle Language Packs](https://docs.moodle.org/dev/String_API)
