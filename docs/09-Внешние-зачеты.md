# Этап 9: Реализация системы внешних зачетов

## Введение

В некоторых случаях студентам нужно засчитать предметы, пройденные в других учебных заведениях, но которых нет в Moodle. Для этого была реализована система внешних зачетов, которая позволяет администраторам отмечать предметы как засчитанные извне с указанием учебного заведения, оценки и других данных.

## Проблема

Когда студент переходит из другого учебного заведения или проходит предмет в другой школе, этого курса может не быть в Moodle. Однако нужно:
- Учесть этот предмет в программе студента
- Показать статус завершения и оценку
- Сохранить информацию об учебном заведении и документе о зачете

## Решение: Таблица внешних зачетов

Было решено создать отдельную таблицу `local_deanpromoodle_student_external_credits` для хранения информации о внешних зачетах. Это позволяет:
- Четко разделить внутренние и внешние зачеты
- Хранить дополнительную информацию (учебное заведение, документ, дата)
- Легко отслеживать и фильтровать внешние зачеты
- Не засорять систему курсами-заглушками

## Шаг 1: Создание таблицы в install.xml

Создаем таблицу в файле `db/install.xml`:

```xml
<!-- Таблица внешних зачетов студентов (предметы, засчитанные из других учебных заведений) -->
<TABLE NAME="local_deanpromoodle_student_external_credits" COMMENT="Внешние зачеты студентов из других учебных заведений">
  <FIELDS>
    <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
    <FIELD NAME="studentid" TYPE="int" LENGTH="10" NOTNULL="true"/>
    <FIELD NAME="subjectid" TYPE="int" LENGTH="10" NOTNULL="true"/>
    <FIELD NAME="grade" TYPE="char" LENGTH="10" NOTNULL="false" COMMENT="Оценка: 3, 4, 5 или процент"/>
    <FIELD NAME="grade_percent" TYPE="number" LENGTH="5,2" NOTNULL="false" COMMENT="Оценка в процентах (0-100)"/>
    <FIELD NAME="institution_name" TYPE="char" LENGTH="255" NOTNULL="false" COMMENT="Название учебного заведения"/>
    <FIELD NAME="institution_id" TYPE="int" LENGTH="10" NOTNULL="false" COMMENT="ID учебного заведения из local_deanpromoodle_institutions"/>
    <FIELD NAME="credited_date" TYPE="int" LENGTH="10" NOTNULL="false" COMMENT="Дата зачета (timestamp)"/>
    <FIELD NAME="document_number" TYPE="char" LENGTH="100" NOTNULL="false" COMMENT="Номер документа о зачете"/>
    <FIELD NAME="notes" TYPE="text" NOTNULL="false" COMMENT="Примечания"/>
    <FIELD NAME="createdby" TYPE="int" LENGTH="10" NOTNULL="true" COMMENT="Кто добавил запись"/>
    <FIELD NAME="timecreated" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0"/>
    <FIELD NAME="timemodified" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0"/>
  </FIELDS>
  <KEYS>
    <KEY NAME="primary" TYPE="primary" FIELDS="id"/>
    <KEY NAME="studentid" TYPE="foreign" FIELDS="studentid" REFTABLE="user" REFFIELDS="id"/>
    <KEY NAME="subjectid" TYPE="foreign" FIELDS="subjectid" REFTABLE="local_deanpromoodle_subjects" REFFIELDS="id"/>
    <KEY NAME="createdby" TYPE="foreign" FIELDS="createdby" REFTABLE="user" REFFIELDS="id"/>
    <KEY NAME="institution_id" TYPE="foreign" FIELDS="institution_id" REFTABLE="local_deanpromoodle_institutions" REFFIELDS="id"/>
    <KEY NAME="student_subject" TYPE="unique" FIELDS="studentid, subjectid" COMMENT="Один студент может иметь только один внешний зачет по предмету"/>
  </KEYS>
  <INDEXES>
    <INDEX NAME="credited_date" UNIQUE="false" FIELDS="credited_date"/>
    <INDEX NAME="institution_name" UNIQUE="false" FIELDS="institution_name"/>
  </INDEXES>
</TABLE>
```

### Объяснение полей:

- **id** - Уникальный идентификатор записи
- **studentid** - ID студента (связь с таблицей `user`)
- **subjectid** - ID предмета (связь с таблицей `local_deanpromoodle_subjects`)
- **grade** - Текстовая оценка (3, 4, 5 или процент)
- **grade_percent** - Оценка в процентах (0-100) для точных расчетов
- **institution_name** - Название учебного заведения (текст)
- **institution_id** - ID учебного заведения из таблицы `local_deanpromoodle_institutions` (опционально)
- **credited_date** - Дата зачета (timestamp)
- **document_number** - Номер документа о зачете
- **notes** - Дополнительные примечания
- **createdby** - ID пользователя, который добавил запись
- **timecreated**, **timemodified** - Временные метки создания и изменения

### Важные моменты:

1. **UNIQUE ключ `student_subject`** - гарантирует, что один студент может иметь только один внешний зачет по каждому предмету
2. **Внешние ключи** - обеспечивают целостность данных
3. **Индексы** - ускоряют поиск по дате зачета и названию учебного заведения

## Шаг 2: Добавление upgrade.php

Для существующих установок плагина нужно добавить код создания таблицы в `db/upgrade.php`:

```php
// Добавление таблицы внешних зачетов студентов
if ($oldversion < 2026021001) {
    $table = new xmldb_table('local_deanpromoodle_student_external_credits');
    
    if (!$dbman->table_exists($table)) {
        // Создаем поля таблицы
        $table->add_field('id', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, XMLDB_SEQUENCE, null);
        $table->add_field('studentid', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);
        $table->add_field('subjectid', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);
        $table->add_field('grade', XMLDB_TYPE_CHAR, '10', null, XMLDB_NOTNULL, null, null, 'Оценка: 3, 4, 5 или процент');
        $table->add_field('grade_percent', XMLDB_TYPE_NUMBER, '5,2', null, XMLDB_NOTNULL, null, null, 'Оценка в процентах (0-100)');
        $table->add_field('institution_name', XMLDB_TYPE_CHAR, '255', null, XMLDB_NOTNULL, null, null, 'Название учебного заведения');
        $table->add_field('institution_id', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null, 'ID учебного заведения');
        $table->add_field('credited_date', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null, 'Дата зачета (timestamp)');
        $table->add_field('document_number', XMLDB_TYPE_CHAR, '100', null, XMLDB_NOTNULL, null, null, 'Номер документа о зачете');
        $table->add_field('notes', XMLDB_TYPE_TEXT, null, null, XMLDB_NOTNULL, null, null, 'Примечания');
        $table->add_field('createdby', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null, 'Кто добавил запись');
        $table->add_field('timecreated', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, '0');
        $table->add_field('timemodified', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, '0');
        
        // Добавляем ключи
        $table->add_key('primary', XMLDB_KEY_PRIMARY, ['id']);
        $table->add_key('studentid', XMLDB_KEY_FOREIGN, ['studentid'], 'user', ['id']);
        $table->add_key('subjectid', XMLDB_KEY_FOREIGN, ['subjectid'], 'local_deanpromoodle_subjects', ['id']);
        $table->add_key('createdby', XMLDB_KEY_FOREIGN, ['createdby'], 'user', ['id']);
        $table->add_key('institution_id', XMLDB_KEY_FOREIGN, ['institution_id'], 'local_deanpromoodle_institutions', ['id']);
        $table->add_key('student_subject', XMLDB_KEY_UNIQUE, ['studentid', 'subjectid'], null, null, 'Один студент может иметь только один внешний зачет по предмету');
        
        // Добавляем индексы
        $table->add_index('credited_date', XMLDB_INDEX_NOTUNIQUE, ['credited_date']);
        $table->add_index('institution_name', XMLDB_INDEX_NOTUNIQUE, ['institution_name']);
        
        $dbman->create_table($table);
    }
    
    upgrade_plugin_savepoint(true, 2026021001, 'local', 'deanpromoodle');
}
```

### Объяснение:

1. **Проверка версии** - `if ($oldversion < 2026021001)` гарантирует, что код выполнится только один раз
2. **Проверка существования таблицы** - `if (!$dbman->table_exists($table))` предотвращает ошибки при повторном запуске
3. **Создание полей** - каждое поле добавляется с указанием типа, размера и других параметров
4. **Добавление ключей** - внешние ключи и уникальный ключ для обеспечения целостности данных
5. **Сохранение точки обновления** - `upgrade_plugin_savepoint()` фиксирует версию обновления

## Шаг 3: Обновление version.php

Обновляем версию плагина в `version.php`:

```php
$plugin->version = 2026021001; // YYYYMMDDXX format - добавлена таблица внешних зачетов студентов
```

## Шаг 4: Создание интерфейса управления

### 4.1. Добавление подвкладки в student.php

Добавляем подвкладку "Внешние зачеты" в раздел "Личная информация и статус":

```php
// Подвкладка "Внешние зачеты" видна только администраторам
if ($isadmin) {
    $subtaburlparams['subtab'] = 'external_credits';
    $subtabs[] = new tabobject('external_credits', 
        new moodle_url('/local/deanpromoodle/pages/student.php', $subtaburlparams),
        'Внешние зачеты');
}
```

### 4.2. Обработка действий

Добавляем обработку действий добавления, редактирования и удаления внешних зачетов:

```php
case 'external_credits':
    // Подвкладка "Внешние зачеты" - только для администраторов
    if (!$isadmin) {
        redirect(new moodle_url('/local/deanpromoodle/pages/student.php', [
            'tab' => 'programs',
            'subtab' => 'programs',
            'studentid' => $studentid
        ]));
    }
    
    // Обработка действий с внешними зачетами
    $externalcreditid = optional_param('externalcreditid', 0, PARAM_INT);
    
    // Добавление/редактирование внешнего зачета
    if (($action == 'add_external_credit' || $action == 'edit_external_credit') && $externalcreditid >= 0) {
        $subjectid = optional_param('subjectid', 0, PARAM_INT);
        $grade = optional_param('grade', '', PARAM_TEXT);
        $grade_percent = optional_param('grade_percent', null, PARAM_FLOAT);
        $institution_name = optional_param('institution_name', '', PARAM_TEXT);
        $institution_id = optional_param('institution_id', 0, PARAM_INT);
        $credited_date_str = optional_param('credited_date', '', PARAM_TEXT); // Дата в формате YYYY-MM-DD
        $document_number = optional_param('document_number', '', PARAM_TEXT);
        $notes = optional_param('notes', '', PARAM_TEXT);
        
        // Преобразуем дату из строки в timestamp
        $credited_date = 0;
        if (!empty($credited_date_str)) {
            $credited_date = strtotime($credited_date_str . ' 00:00:00');
        }
        
        if ($subjectid > 0 && !empty($institution_name)) {
            try {
                if ($action == 'add_external_credit') {
                    // Проверяем, нет ли уже внешнего зачета по этому предмету
                    $existing = $DB->get_record('local_deanpromoodle_student_external_credits', [
                        'studentid' => $viewingstudent->id,
                        'subjectid' => $subjectid
                    ]);
                    
                    if ($existing) {
                        echo html_writer::div('Внешний зачет по этому предмету уже существует. Используйте редактирование.', 'alert alert-warning');
                    } else {
                        $record = new stdClass();
                        $record->studentid = $viewingstudent->id;
                        $record->subjectid = $subjectid;
                        $record->grade = $grade ?: null;
                        $record->grade_percent = $grade_percent;
                        $record->institution_name = $institution_name;
                        $record->institution_id = $institution_id > 0 ? $institution_id : null;
                        $record->credited_date = $credited_date > 0 ? $credited_date : time();
                        $record->document_number = $document_number ?: null;
                        $record->notes = $notes ?: null;
                        $record->createdby = $USER->id;
                        $record->timecreated = time();
                        $record->timemodified = time();
                        
                        $DB->insert_record('local_deanpromoodle_student_external_credits', $record);
                        
                        $redirecturl = new moodle_url('/local/deanpromoodle/pages/student.php', [
                            'tab' => 'programs',
                            'subtab' => 'external_credits',
                            'studentid' => $studentid
                        ]);
                        redirect($redirecturl, 'Внешний зачет успешно добавлен', null, \core\output\notification::NOTIFY_SUCCESS);
                    }
                } else if ($action == 'edit_external_credit' && $externalcreditid > 0) {
                    $record = $DB->get_record('local_deanpromoodle_student_external_credits', [
                        'id' => $externalcreditid,
                        'studentid' => $viewingstudent->id
                    ]);
                    
                    if ($record) {
                        $record->subjectid = $subjectid;
                        $record->grade = $grade ?: null;
                        $record->grade_percent = $grade_percent;
                        $record->institution_name = $institution_name;
                        $record->institution_id = $institution_id > 0 ? $institution_id : null;
                        $record->credited_date = $credited_date > 0 ? $credited_date : $record->credited_date;
                        $record->document_number = $document_number ?: null;
                        $record->notes = $notes ?: null;
                        $record->timemodified = time();
                        
                        $DB->update_record('local_deanpromoodle_student_external_credits', $record);
                        
                        $redirecturl = new moodle_url('/local/deanpromoodle/pages/student.php', [
                            'tab' => 'programs',
                            'subtab' => 'external_credits',
                            'studentid' => $studentid
                        ]);
                        redirect($redirecturl, 'Внешний зачет успешно обновлен', null, \core\output\notification::NOTIFY_SUCCESS);
                    } else {
                        echo html_writer::div('Внешний зачет не найден', 'alert alert-danger');
                    }
                }
            } catch (\Exception $e) {
                echo html_writer::div('Ошибка: ' . $e->getMessage(), 'alert alert-danger');
            }
        }
    }
    
    // Удаление внешнего зачета
    if ($action == 'delete_external_credit' && $externalcreditid > 0) {
        require_sesskey();
        try {
            $record = $DB->get_record('local_deanpromoodle_student_external_credits', [
                'id' => $externalcreditid,
                'studentid' => $viewingstudent->id
            ]);
            
            if ($record) {
                $DB->delete_records('local_deanpromoodle_student_external_credits', ['id' => $externalcreditid]);
                
                $redirecturl = new moodle_url('/local/deanpromoodle/pages/student.php', [
                    'tab' => 'programs',
                    'subtab' => 'external_credits',
                    'studentid' => $studentid
                ]);
                redirect($redirecturl, 'Внешний зачет успешно удален', null, \core\output\notification::NOTIFY_SUCCESS);
            } else {
                echo html_writer::div('Внешний зачет не найден', 'alert alert-danger');
            }
        } catch (\Exception $e) {
            echo html_writer::div('Ошибка: ' . $e->getMessage(), 'alert alert-danger');
        }
    }
    
    // ... код формы и списка внешних зачетов ...
    break;
```

### 4.3. Форма добавления/редактирования

Создаем форму для ввода данных о внешнем зачете:

```php
// Форма добавления/редактирования
if ($action == 'add_external_credit' || ($action == 'edit_external_credit' && $externalcreditid > 0)) {
    $externalcredit = null;
    if ($action == 'edit_external_credit' && $externalcreditid > 0) {
        $externalcredit = $DB->get_record('local_deanpromoodle_student_external_credits', [
            'id' => $externalcreditid,
            'studentid' => $viewingstudent->id
        ]);
    }
    
    echo html_writer::tag('h3', $action == 'add_external_credit' ? 'Добавить внешний зачет' : 'Редактировать внешний зачет');
    
    // Получаем список предметов
    $subjects = $DB->get_records('local_deanpromoodle_subjects', ['visible' => 1], 'name ASC');
    $subjectoptions = [0 => 'Выберите предмет'];
    foreach ($subjects as $subject) {
        $subjectoptions[$subject->id] = $subject->name . ($subject->code ? ' (' . $subject->code . ')' : '');
    }
    
    // Получаем список учебных заведений
    $institutions = $DB->get_records('local_deanpromoodle_institutions', ['visible' => 1], 'name ASC');
    $institutionoptions = [0 => 'Выберите учебное заведение (или введите название вручную)'];
    foreach ($institutions as $institution) {
        $institutionoptions[$institution->id] = $institution->name;
    }
    
    $formurl = new moodle_url('/local/deanpromoodle/pages/student.php', [
        'tab' => 'programs',
        'subtab' => 'external_credits',
        'action' => $action,
        'studentid' => $studentid
    ]);
    if ($externalcreditid > 0) {
        $formurl->param('externalcreditid', $externalcreditid);
    }
    
    echo html_writer::start_tag('form', [
        'method' => 'post',
        'action' => $formurl->out(false)
    ]);
    echo html_writer::empty_tag('input', ['type' => 'hidden', 'name' => 'sesskey', 'value' => sesskey()]);
    
    echo html_writer::start_tag('table', ['class' => 'table', 'style' => 'max-width: 800px;']);
    
    // Предмет
    echo html_writer::start_tag('tr');
    echo html_writer::tag('td', html_writer::label('Предмет *', 'subjectid'), ['style' => 'width: 200px;']);
    echo html_writer::start_tag('td');
    echo html_writer::select($subjectoptions, 'subjectid', $externalcredit ? $externalcredit->subjectid : 0, false, ['class' => 'form-control', 'required' => 'required']);
    echo html_writer::end_tag('td');
    echo html_writer::end_tag('tr');
    
    // Оценка (текст)
    echo html_writer::start_tag('tr');
    echo html_writer::tag('td', html_writer::label('Оценка (3, 4, 5 или процент)', 'grade'));
    echo html_writer::start_tag('td');
    echo html_writer::empty_tag('input', [
        'type' => 'text',
        'name' => 'grade',
        'id' => 'grade',
        'class' => 'form-control',
        'value' => $externalcredit ? $externalcredit->grade : '',
        'placeholder' => '3, 4, 5 или процент'
    ]);
    echo html_writer::end_tag('td');
    echo html_writer::end_tag('tr');
    
    // Оценка в процентах
    echo html_writer::start_tag('tr');
    echo html_writer::tag('td', html_writer::label('Оценка в процентах (0-100)', 'grade_percent'));
    echo html_writer::start_tag('td');
    echo html_writer::empty_tag('input', [
        'type' => 'number',
        'name' => 'grade_percent',
        'id' => 'grade_percent',
        'class' => 'form-control',
        'value' => $externalcredit && $externalcredit->grade_percent ? $externalcredit->grade_percent : '',
        'min' => '0',
        'max' => '100',
        'step' => '0.01',
        'placeholder' => '0-100'
    ]);
    echo html_writer::end_tag('td');
    echo html_writer::end_tag('tr');
    
    // Учебное заведение (выбор из списка)
    echo html_writer::start_tag('tr');
    echo html_writer::tag('td', html_writer::label('Учебное заведение (из списка)', 'institution_id'));
    echo html_writer::start_tag('td');
    echo html_writer::select($institutionoptions, 'institution_id', $externalcredit && $externalcredit->institution_id ? $externalcredit->institution_id : 0, false, ['class' => 'form-control']);
    echo html_writer::end_tag('td');
    echo html_writer::end_tag('tr');
    
    // Название учебного заведения (вручную)
    echo html_writer::start_tag('tr');
    echo html_writer::tag('td', html_writer::label('Название учебного заведения *', 'institution_name'));
    echo html_writer::start_tag('td');
    echo html_writer::empty_tag('input', [
        'type' => 'text',
        'name' => 'institution_name',
        'id' => 'institution_name',
        'class' => 'form-control',
        'value' => $externalcredit ? $externalcredit->institution_name : '',
        'required' => 'required',
        'placeholder' => 'Название учебного заведения'
    ]);
    echo html_writer::end_tag('td');
    echo html_writer::end_tag('tr');
    
    // Дата зачета
    echo html_writer::start_tag('tr');
    echo html_writer::tag('td', html_writer::label('Дата зачета', 'credited_date'));
    echo html_writer::start_tag('td');
    $credited_date_value = $externalcredit && $externalcredit->credited_date > 0 ? date('Y-m-d', $externalcredit->credited_date) : date('Y-m-d');
    echo html_writer::empty_tag('input', [
        'type' => 'date',
        'name' => 'credited_date',
        'id' => 'credited_date',
        'class' => 'form-control',
        'value' => $credited_date_value
    ]);
    echo html_writer::end_tag('td');
    echo html_writer::end_tag('tr');
    
    // Номер документа
    echo html_writer::start_tag('tr');
    echo html_writer::tag('td', html_writer::label('Номер документа о зачете', 'document_number'));
    echo html_writer::start_tag('td');
    echo html_writer::empty_tag('input', [
        'type' => 'text',
        'name' => 'document_number',
        'id' => 'document_number',
        'class' => 'form-control',
        'value' => $externalcredit ? $externalcredit->document_number : '',
        'placeholder' => 'Номер документа'
    ]);
    echo html_writer::end_tag('td');
    echo html_writer::end_tag('tr');
    
    // Примечания
    echo html_writer::start_tag('tr');
    echo html_writer::tag('td', html_writer::label('Примечания', 'notes'), ['style' => 'vertical-align: top;']);
    echo html_writer::start_tag('td');
    echo html_writer::tag('textarea', $externalcredit ? htmlspecialchars($externalcredit->notes, ENT_QUOTES, 'UTF-8') : '', [
        'name' => 'notes',
        'id' => 'notes',
        'class' => 'form-control',
        'rows' => '3',
        'placeholder' => 'Дополнительные примечания'
    ]);
    echo html_writer::end_tag('td');
    echo html_writer::end_tag('tr');
    
    echo html_writer::end_tag('table');
    
    echo html_writer::start_tag('div', ['style' => 'margin-top: 15px;']);
    echo html_writer::empty_tag('input', [
        'type' => 'submit',
        'value' => $action == 'add_external_credit' ? 'Добавить' : 'Сохранить',
        'class' => 'btn btn-primary',
        'style' => 'margin-right: 10px;'
    ]);
    $cancelurl = new moodle_url('/local/deanpromoodle/pages/student.php', [
        'tab' => 'programs',
        'subtab' => 'external_credits',
        'studentid' => $studentid
    ]);
    echo html_writer::link($cancelurl, 'Отмена', ['class' => 'btn btn-secondary']);
    echo html_writer::end_tag('div');
    
    echo html_writer::end_tag('form');
}
```

### 4.4. Отображение списка внешних зачетов

Создаем таблицу со списком внешних зачетов студента:

```php
// Список внешних зачетов
else {
    echo html_writer::tag('h3', 'Внешние зачеты студента: ' . fullname($viewingstudent));
    
    // Кнопка добавления
    $addurl = new moodle_url('/local/deanpromoodle/pages/student.php', [
        'tab' => 'programs',
        'subtab' => 'external_credits',
        'action' => 'add_external_credit',
        'studentid' => $studentid
    ]);
    echo html_writer::link($addurl, '<i class="fas fa-plus"></i> Добавить внешний зачет', [
        'class' => 'btn btn-primary',
        'style' => 'margin-bottom: 20px;'
    ]);
    
    // Получаем внешние зачеты студента
    $externalcredits = $DB->get_records_sql(
        "SELECT ec.*, s.name as subject_name, s.code as subject_code,
                u.firstname as creator_firstname, u.lastname as creator_lastname
         FROM {local_deanpromoodle_student_external_credits} ec
         JOIN {local_deanpromoodle_subjects} s ON s.id = ec.subjectid
         LEFT JOIN {user} u ON u.id = ec.createdby
         WHERE ec.studentid = ?
         ORDER BY ec.credited_date DESC, s.name ASC",
        [$viewingstudent->id]
    );
    
    if (empty($externalcredits)) {
        echo html_writer::div('Внешние зачеты не найдены.', 'alert alert-info');
    } else {
        echo html_writer::start_tag('table', ['class' => 'table table-striped table-hover']);
        echo html_writer::start_tag('thead');
        echo html_writer::start_tag('tr');
        echo html_writer::tag('th', 'Предмет');
        echo html_writer::tag('th', 'Оценка');
        echo html_writer::tag('th', 'Учебное заведение');
        echo html_writer::tag('th', 'Дата зачета');
        echo html_writer::tag('th', 'Документ');
        echo html_writer::tag('th', 'Добавил');
        echo html_writer::tag('th', 'Действия', ['style' => 'width: 150px;']);
        echo html_writer::end_tag('tr');
        echo html_writer::end_tag('thead');
        echo html_writer::start_tag('tbody');
        
        foreach ($externalcredits as $credit) {
            echo html_writer::start_tag('tr');
            
            // Предмет
            $subjectname = $credit->subject_name;
            if ($credit->subject_code) {
                $subjectname .= ' (' . htmlspecialchars($credit->subject_code, ENT_QUOTES, 'UTF-8') . ')';
            }
            echo html_writer::tag('td', htmlspecialchars($subjectname, ENT_QUOTES, 'UTF-8'));
            
            // Оценка
            $gradedisplay = '-';
            if ($credit->grade_percent !== null) {
                $gradedisplay = round($credit->grade_percent, 2) . '%';
                if ($credit->grade) {
                    $gradedisplay .= ' (' . htmlspecialchars($credit->grade, ENT_QUOTES, 'UTF-8') . ')';
                }
            } else if ($credit->grade) {
                $gradedisplay = htmlspecialchars($credit->grade, ENT_QUOTES, 'UTF-8');
            }
            echo html_writer::tag('td', $gradedisplay);
            
            // Учебное заведение
            echo html_writer::tag('td', htmlspecialchars($credit->institution_name, ENT_QUOTES, 'UTF-8'));
            
            // Дата зачета
            $date = $credit->credited_date > 0 ? userdate($credit->credited_date, '%d.%m.%Y') : '-';
            echo html_writer::tag('td', $date);
            
            // Документ
            echo html_writer::tag('td', $credit->document_number ? htmlspecialchars($credit->document_number, ENT_QUOTES, 'UTF-8') : '-');
            
            // Добавил
            $creator = $credit->creator_firstname && $credit->creator_lastname 
                ? fullname((object)['firstname' => $credit->creator_firstname, 'lastname' => $credit->creator_lastname])
                : '-';
            echo html_writer::tag('td', htmlspecialchars($creator, ENT_QUOTES, 'UTF-8'));
            
            // Действия
            echo html_writer::start_tag('td');
            $editurl = new moodle_url('/local/deanpromoodle/pages/student.php', [
                'tab' => 'programs',
                'subtab' => 'external_credits',
                'action' => 'edit_external_credit',
                'externalcreditid' => $credit->id,
                'studentid' => $studentid
            ]);
            echo html_writer::link($editurl, '<i class="fas fa-edit"></i>', [
                'class' => 'btn btn-sm btn-warning',
                'title' => 'Редактировать',
                'style' => 'margin-right: 5px;'
            ]);
            
            $deleteurl = new moodle_url('/local/deanpromoodle/pages/student.php', [
                'tab' => 'programs',
                'subtab' => 'external_credits',
                'action' => 'delete_external_credit',
                'externalcreditid' => $credit->id,
                'studentid' => $studentid,
                'sesskey' => sesskey()
            ]);
            echo html_writer::link($deleteurl, '<i class="fas fa-trash"></i>', [
                'class' => 'btn btn-sm btn-danger',
                'title' => 'Удалить',
                'onclick' => 'return confirm(\'Вы уверены, что хотите удалить этот внешний зачет?\');'
            ]);
            echo html_writer::end_tag('td');
            
            echo html_writer::end_tag('tr');
            
            // Примечания (если есть) - в отдельной строке
            if (!empty($credit->notes)) {
                echo html_writer::start_tag('tr', ['style' => 'background-color: #f8f9fa;']);
                echo html_writer::tag('td', '<strong>Примечания:</strong> ' . htmlspecialchars($credit->notes, ENT_QUOTES, 'UTF-8'), [
                    'colspan' => '7',
                    'style' => 'font-size: 0.9em; padding: 8px 16px;'
                ]);
                echo html_writer::end_tag('tr');
            }
        }
        
        echo html_writer::end_tag('tbody');
        echo html_writer::end_tag('table');
    }
}
```

## Шаг 5: Интеграция в отображение программы

### 5.1. Проверка внешних зачетов при просмотре программы

При отображении программы студента нужно проверять не только курсы Moodle, но и внешние зачеты:

```php
foreach ($subjects as $index => $subject) {
    // Проверяем внешний зачет по этому предмету (проверяем заранее, чтобы использовать в tooltip)
    $externalcredit = $DB->get_record('local_deanpromoodle_student_external_credits', [
        'studentid' => $viewingstudent->id,
        'subjectid' => $subject->id
    ]);
    
    // ... код получения курсов и вычисления статуса ...
    
    // Обрабатываем внешний зачет, если он есть
    if ($externalcredit) {
        // Если есть внешний зачет, используем его данные
        $externalgradepercent = $externalcredit->grade_percent !== null ? $externalcredit->grade_percent : null;
        
        // Определяем оценку из внешнего зачета
        if ($externalgradepercent !== null) {
            $externalgradetext = '';
            $externalgradeclass = '';
            $externalgradeicon = '';
            
            if ($externalgradepercent < 70) {
                $externalgradetext = 'нет оценки';
                $externalgradeclass = 'grade-badge-no-grade';
                $externalgradeicon = '<i class="fas fa-minus-circle"></i>';
            } elseif ($externalgradepercent >= 70 && $externalgradepercent < 80) {
                $externalgradetext = '3 (удовлетворительно)';
                $externalgradeclass = 'grade-badge-satisfactory';
                $externalgradeicon = '<i class="fas fa-check-circle"></i>';
            } elseif ($externalgradepercent >= 80 && $externalgradepercent < 90) {
                $externalgradetext = '4 (хорошо)';
                $externalgradeclass = 'grade-badge-good';
                $externalgradeicon = '<i class="fas fa-star"></i>';
            } elseif ($externalgradepercent >= 90) {
                $externalgradetext = '5 (отлично)';
                $externalgradeclass = 'grade-badge-excellent';
                $externalgradeicon = '<i class="fas fa-trophy"></i>';
            }
            
            // Определяем статус завершения из внешнего зачета
            $externalcompletionstatus = 'Завершен полностью';
            $externalcompletionclass = 'completion-status-completed';
            if ($externalgradepercent !== null) {
                $externalcompletionstatus .= ' - ' . round($externalgradepercent, 2) . '%';
            }
            
            // Внешний зачет имеет приоритет, если он лучше или если нет курсов
            if ($bestGradePercent === null || $externalgradepercent > $bestGradePercent) {
                $bestGrade = [
                    'gradetext' => $externalgradetext,
                    'gradeclass' => $externalgradeclass,
                    'gradeicon' => $externalgradeicon,
                    'finalgradepercent' => $externalgradepercent
                ];
                $bestGradePercent = $externalgradepercent;
            }
            
            // Статус завершения из внешнего зачета всегда "Завершен полностью"
            if ($bestCompletion === null || strpos($bestCompletion['completionstatus'], 'Завершен полностью') === false) {
                $bestCompletion = [
                    'completionstatus' => $externalcompletionstatus,
                    'completionclass' => $externalcompletionclass,
                    'finalgradepercent' => $externalgradepercent
                ];
            }
        }
    }
    
    // ... остальной код отображения ...
}
```

### 5.2. Добавление информации о внешнем зачете в tooltip

Обновляем tooltip названия предмета, чтобы показывать информацию о внешнем зачете:

```php
// Добавляем информацию о внешнем зачете в tooltip
if ($externalcredit) {
    $externalInfo = 'Внешний зачет: ' . htmlspecialchars($externalcredit->institution_name, ENT_QUOTES, 'UTF-8');
    if ($externalcredit->grade_percent !== null) {
        $externalInfo .= ' (' . round($externalcredit->grade_percent, 2) . '%)';
    } else if ($externalcredit->grade) {
        $externalInfo .= ' (оценка: ' . htmlspecialchars($externalcredit->grade, ENT_QUOTES, 'UTF-8') . ')';
    }
    if ($externalcredit->credited_date > 0) {
        $externalInfo .= ', дата: ' . userdate($externalcredit->credited_date, '%d.%m.%Y');
    }
    $tooltipParts[] = $externalInfo;
}
```

## Шаг 6: Логика приоритетов

При определении статуса завершения и оценки учитываются следующие приоритеты:

1. **Внешний зачет** - если есть внешний зачет, он всегда показывает статус "Завершен полностью"
2. **Лучшая оценка** - если есть и курсы, и внешний зачет, выбирается лучшая оценка (наибольший процент)
3. **Статус завершения** - внешний зачет всегда имеет статус "Завершен полностью", но если есть курсы с лучшим статусом, он может быть переопределен

### Пример логики:

```php
// Внешний зачет имеет приоритет, если он лучше или если нет курсов
if ($bestGradePercent === null || $externalgradepercent > $bestGradePercent) {
    $bestGrade = [
        'gradetext' => $externalgradetext,
        'gradeclass' => $externalgradeclass,
        'gradeicon' => $externalgradeicon,
        'finalgradepercent' => $externalgradepercent
    ];
    $bestGradePercent = $externalgradepercent;
}

// Статус завершения из внешнего зачета всегда "Завершен полностью"
if ($bestCompletion === null || strpos($bestCompletion['completionstatus'], 'Завершен полностью') === false) {
    $bestCompletion = [
        'completionstatus' => $externalcompletionstatus,
        'completionclass' => $externalcompletionclass,
        'finalgradepercent' => $externalgradepercent
    ];
}
```

## Шаг 7: Безопасность

### 7.1. Проверка прав доступа

Интерфейс управления внешними зачетами доступен только администраторам:

```php
if (!$isadmin) {
    redirect(new moodle_url('/local/deanpromoodle/pages/student.php', [
        'tab' => 'programs',
        'subtab' => 'programs',
        'studentid' => $studentid
    ]));
}
```

### 7.2. Проверка sesskey

При удалении внешнего зачета обязательно проверяем sesskey:

```php
if ($action == 'delete_external_credit' && $externalcreditid > 0) {
    require_sesskey();
    // ... код удаления ...
}
```

### 7.3. Проверка принадлежности записи

При редактировании и удалении проверяем, что запись принадлежит правильному студенту:

```php
$record = $DB->get_record('local_deanpromoodle_student_external_credits', [
    'id' => $externalcreditid,
    'studentid' => $viewingstudent->id
]);
```

## Шаг 8: Обработка ошибок

### 8.1. Проверка существования записи

Перед добавлением проверяем, нет ли уже внешнего зачета по этому предмету:

```php
$existing = $DB->get_record('local_deanpromoodle_student_external_credits', [
    'studentid' => $viewingstudent->id,
    'subjectid' => $subjectid
]);

if ($existing) {
    echo html_writer::div('Внешний зачет по этому предмету уже существует. Используйте редактирование.', 'alert alert-warning');
}
```

### 8.2. Обработка исключений

Все операции с базой данных обернуты в try-catch:

```php
try {
    $DB->insert_record('local_deanpromoodle_student_external_credits', $record);
    // ... успешное сообщение ...
} catch (\Exception $e) {
    echo html_writer::div('Ошибка: ' . $e->getMessage(), 'alert alert-danger');
}
```

## Шаг 9: Преобразование даты

Важно правильно обрабатывать дату из формы (формат YYYY-MM-DD) и преобразовывать её в timestamp:

```php
$credited_date_str = optional_param('credited_date', '', PARAM_TEXT); // Дата в формате YYYY-MM-DD

// Преобразуем дату из строки в timestamp
$credited_date = 0;
if (!empty($credited_date_str)) {
    $credited_date = strtotime($credited_date_str . ' 00:00:00');
}
```

И обратно при отображении:

```php
$credited_date_value = $externalcredit && $externalcredit->credited_date > 0 
    ? date('Y-m-d', $externalcredit->credited_date) 
    : date('Y-m-d');
```

## Полный пример использования

### Добавление внешнего зачета:

1. Администратор переходит на страницу студента: `student.php?studentid=123&tab=programs&subtab=external_credits`
2. Нажимает кнопку "Добавить внешний зачет"
3. Заполняет форму:
   - Предмет: "Введение в библейское толкование"
   - Оценка: "5"
   - Оценка в процентах: "95"
   - Учебное заведение: "Московская богословская семинария"
   - Дата зачета: "2025-01-15"
   - Номер документа: "ДИП-2025-001"
   - Примечания: "Зачет по программе перевода"
4. Нажимает "Добавить"
5. Внешний зачет сохраняется в базу данных

### Отображение в программе:

1. Студент просматривает программу: `student.php?action=viewprogram&programid=6`
2. В таблице предметов для "Введение в библейское толкование" отображается:
   - **Статус завершения**: "Завершен полностью - 95%" (зеленым)
   - **Оценка**: "5 (отлично)" (зеленым бейджем)
   - **Tooltip** при наведении на название: "Внешний зачет: Московская богословская семинария (95%), дата: 15.01.2025"

## Резюме

Реализация системы внешних зачетов включает:

1. ✅ Создание таблицы `local_deanpromoodle_student_external_credits`
2. ✅ Добавление upgrade.php для миграции
3. ✅ Обновление version.php
4. ✅ Создание интерфейса управления (добавление, редактирование, удаление)
5. ✅ Интеграция в отображение программы студента
6. ✅ Добавление информации о внешнем зачете в tooltip
7. ✅ Обработка приоритетов между курсами и внешними зачетами
8. ✅ Обеспечение безопасности (проверка прав, sesskey)
9. ✅ Обработка ошибок

Система позволяет администраторам легко управлять внешними зачетами студентов, а студентам видеть полную картину своих достижений, включая предметы, засчитанные из других учебных заведений.
