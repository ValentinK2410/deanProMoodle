# Этап 4: Создание страниц

## Введение

Страницы плагина — это PHP-файлы, которые отображают пользовательский интерфейс. Они должны загружать конфигурацию Moodle, проверять права доступа и использовать Moodle API для работы с данными.

## Базовая структура страницы

### Минимальный пример

```php
<?php
// This file is part of Moodle - http://moodle.org/
//
// Moodle is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// Moodle is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.

/**
 * Student page for local_deanpromoodle plugin.
 *
 * @package    local_deanpromoodle
 * @copyright  2026
 * @author     ValentinK2410 <https://github.com/ValentinK2410>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */

// Загрузка конфигурации Moodle
require_once(__DIR__ . '/../../../config.php');

// Проверка авторизации
require_login();

// Проверка прав доступа
$context = context_system::instance();
require_capability('local/deanpromoodle:viewstudent', $context);

// Настройка страницы
$PAGE->set_url('/local/deanpromoodle/pages/student.php');
$PAGE->set_title(get_string('studentpagetitle', 'local_deanpromoodle'));
$PAGE->set_heading(get_string('studentpagetitle', 'local_deanpromoodle'));
$PAGE->set_pagelayout('standard');

// Вывод заголовка
echo $OUTPUT->header();

// Содержимое страницы
echo html_writer::tag('h1', get_string('studentpagetitle', 'local_deanpromoodle'));
echo html_writer::tag('p', get_string('studentpagecontent', 'local_deanpromoodle'));

// Вывод подвала
echo $OUTPUT->footer();
```

## Пошаговое создание страницы

### Шаг 1: Загрузка конфигурации

```php
// Определение пути к config.php
// Из pages/student.php: ../ (к deanpromoodle) -> ../ (к local) -> ../ (к корню Moodle)
$configpath = __DIR__ . '/../../../config.php';

if (!file_exists($configpath)) {
    die('Error: Moodle config.php not found at: ' . $configpath);
}

require_once($configpath);
```

**Важно:** 
- Используйте `__DIR__` для определения текущей директории
- Проверяйте существование файла перед загрузкой
- Путь зависит от расположения файла относительно корня Moodle

### Шаг 2: Проверка авторизации

```php
// Проверка, что пользователь авторизован
require_login();

// Проверка, что пользователь не гость
if (isguestuser()) {
    redirect(new moodle_url('/login/index.php'));
}
```

**Функции:**
- `require_login()` — требует авторизации, иначе редирект на страницу входа
- `isguestuser()` — проверяет, является ли пользователь гостем
- `isloggedin()` — проверяет, авторизован ли пользователь

### Шаг 3: Проверка прав доступа

```php
// Получение контекста
$context = context_system::instance();

// Проверка capability
if (!has_capability('local/deanpromoodle:viewstudent', $context)) {
    // Альтернативная проверка по ролям
    global $USER;
    $roles = get_user_roles($context, $USER->id, false);
    $hasaccess = false;
    
    foreach ($roles as $role) {
        if ($role->shortname == 'student') {
            $hasaccess = true;
            break;
        }
    }
    
    if (!$hasaccess) {
        require_capability('local/deanpromoodle:viewstudent', $context);
    }
}
```

**Контексты:**
- `context_system::instance()` — системный уровень
- `context_course::instance($courseid)` — уровень курса
- `context_module::instance($cmid)` — уровень модуля

### Шаг 4: Получение параметров

```php
// Получение параметров из URL
$tab = optional_param('tab', 'courses', PARAM_ALPHA);
$subtab = optional_param('subtab', 'programs', PARAM_ALPHA);
$action = optional_param('action', '', PARAM_ALPHA);
$id = optional_param('id', 0, PARAM_INT);
$studentid = optional_param('studentid', 0, PARAM_INT);
$testmode = optional_param('test', false, PARAM_BOOL);
```

**Типы параметров:**
- `PARAM_INT` — целое число
- `PARAM_ALPHA` — только буквы
- `PARAM_ALPHANUM` — буквы и цифры
- `PARAM_TEXT` — текст
- `PARAM_BOOL` — булево значение
- `PARAM_URL` — URL

**Функции:**
- `optional_param('name', default, type)` — опциональный параметр
- `required_param('name', type)` — обязательный параметр

### Шаг 5: Настройка страницы

```php
// Установка URL страницы
$PAGE->set_url('/local/deanpromoodle/pages/student.php', ['tab' => $tab]);

// Установка заголовка
$PAGE->set_title(get_string('studentpagetitle', 'local_deanpromoodle'));

// Установка заголовка страницы
$PAGE->set_heading(get_string('studentpagetitle', 'local_deanpromoodle'));

// Установка макета страницы
$PAGE->set_pagelayout('standard');

// Добавление CSS
$PAGE->requires->css('/local/deanpromoodle/styles.css');

// Добавление JavaScript
$PAGE->requires->js('/local/deanpromoodle/script.js');
```

**Макеты страниц:**
- `standard` — стандартный макет
- `admin` — административный макет
- `popup` — всплывающее окно
- `embedded` — встроенный контент

### Шаг 6: Вывод содержимого

```php
// Вывод заголовка страницы
echo $OUTPUT->header();

// Содержимое страницы
echo html_writer::tag('h1', 'Заголовок');
echo html_writer::tag('p', 'Текст параграфа');

// Вывод подвала страницы
echo $OUTPUT->footer();
```

## Работа с вкладками (Tabs)

### Создание системы вкладок

```php
// Определение вкладок
$tabs = [
    new tabobject('courses', 
        new moodle_url('/local/deanpromoodle/pages/student.php', ['tab' => 'courses']),
        get_string('courses', 'local_deanpromoodle')
    ),
    new tabobject('programs',
        new moodle_url('/local/deanpromoodle/pages/student.php', ['tab' => 'programs']),
        get_string('programs', 'local_deanpromoodle')
    ),
];

// Вывод вкладок
echo $OUTPUT->tabtree($tabs, $tab);
```

### Вложенные вкладки

```php
// Основные вкладки
$tabs = [
    new tabobject('programs', 
        new moodle_url('/local/deanpromoodle/pages/student.php', ['tab' => 'programs']),
        get_string('programs', 'local_deanpromoodle')
    ),
];

// Если выбрана вкладка programs, показываем подвкладки
if ($tab == 'programs') {
    $subtabs = [
        new tabobject('programs',
            new moodle_url('/local/deanpromoodle/pages/student.php', [
                'tab' => 'programs',
                'subtab' => 'programs'
            ]),
            get_string('programs', 'local_deanpromoodle')
        ),
        new tabobject('additional',
            new moodle_url('/local/deanpromoodle/pages/student.php', [
                'tab' => 'programs',
                'subtab' => 'additional'
            ]),
            get_string('additional', 'local_deanpromoodle')
        ),
    ];
    
    echo $OUTPUT->tabtree($subtabs, $subtab);
}
```

## Работа с формами

### Создание формы

```php
// Определение формы
$mform = new local_deanpromoodle_student_form();

// Обработка данных формы
if ($mform->is_cancelled()) {
    // Отмена формы
    redirect(new moodle_url('/local/deanpromoodle/pages/student.php'));
} else if ($data = $mform->get_data()) {
    // Сохранение данных
    global $DB, $USER;
    
    $record = new stdClass();
    $record->userid = $USER->id;
    $record->field1 = $data->field1;
    $record->field2 = $data->field2;
    $record->timemodified = time();
    
    if ($existing = $DB->get_record('local_deanpromoodle_student_info', ['userid' => $USER->id])) {
        $record->id = $existing->id;
        $DB->update_record('local_deanpromoodle_student_info', $record);
    } else {
        $record->timecreated = time();
        $DB->insert_record('local_deanpromoodle_student_info', $record);
    }
    
    redirect(new moodle_url('/local/deanpromoodle/pages/student.php', ['tab' => 'programs', 'subtab' => 'additional']));
}

// Отображение формы
$mform->display();
```

## Работа с таблицами данных

### Создание таблицы

```php
// Определение колонок
$table = new html_table();
$table->head = [
    get_string('coursename', 'local_deanpromoodle'),
    get_string('grade', 'local_deanpromoodle'),
    get_string('status', 'local_deanpromoodle'),
];

// Получение данных
global $DB, $USER;
$courses = enrol_get_all_users_courses($USER->id);

// Заполнение таблицы
$table->data = [];
foreach ($courses as $course) {
    $row = [];
    $row[] = $course->fullname;
    $row[] = get_course_grade($course->id, $USER->id);
    $row[] = get_course_status($course->id, $USER->id);
    $table->data[] = $row;
}

// Вывод таблицы
echo html_writer::table($table);
```

### Пагинация

```php
// Параметры пагинации
$perpage = 20;
$page = optional_param('page', 0, PARAM_INT);
$totalcount = count($allrecords);

// Вычисление смещения
$offset = $page * $perpage;

// Получение записей для текущей страницы
$records = array_slice($allrecords, $offset, $perpage);

// Вывод пагинации
$pagingbar = new paging_bar($totalcount, $page, $perpage, 
    new moodle_url('/local/deanpromoodle/pages/student.php', ['tab' => 'courses']));
echo $OUTPUT->render($pagingbar);
```

## Работа с AJAX

### Создание AJAX обработчика

**Файл: `pages/admin_ajax.php`**

```php
<?php
require_once(__DIR__ . '/../../../config.php');
require_login();

$action = required_param('action', PARAM_ALPHA);

header('Content-Type: application/json');

switch ($action) {
    case 'searchstudents':
        $query = optional_param('studentname', '', PARAM_TEXT);
        
        global $DB;
        $students = $DB->get_records_sql(
            "SELECT id, firstname, lastname, email 
             FROM {user} 
             WHERE deleted = 0 
             AND (firstname LIKE ? OR lastname LIKE ? OR email LIKE ?)
             LIMIT 50",
            ["%{$query}%", "%{$query}%", "%{$query}%"]
        );
        
        echo json_encode(array_values($students));
        break;
        
    default:
        http_response_code(400);
        echo json_encode(['error' => 'Invalid action']);
}
```

### Использование AJAX в JavaScript

```javascript
function searchStudents(query) {
    fetch('/local/deanpromoodle/pages/admin_ajax.php?action=searchstudents&studentname=' + encodeURIComponent(query))
        .then(response => response.json())
        .then(data => {
            // Обработка данных
            displayStudents(data);
        })
        .catch(error => {
            console.error('Error:', error);
        });
}
```

## Безопасность

### Защита от SQL-инъекций

```php
// ✅ Правильно - использование параметров
$students = $DB->get_records_sql(
    "SELECT * FROM {user} WHERE firstname LIKE ?",
    ["%{$query}%"]
);

// ❌ Неправильно - прямая подстановка
$students = $DB->get_records_sql(
    "SELECT * FROM {user} WHERE firstname LIKE '%{$query}%'"
);
```

### Защита от XSS

```php
// ✅ Правильно - использование html_writer
echo html_writer::tag('div', htmlspecialchars($user->firstname));

// ❌ Неправильно - прямая подстановка
echo "<div>{$user->firstname}</div>";
```

### Проверка прав доступа

```php
// Всегда проверяйте права перед выполнением действий
if (!has_capability('local/deanpromoodle:viewadmin', $context)) {
    print_error('accessdenied', 'local_deanpromoodle');
}
```

## Пример полной страницы

```php
<?php
require_once(__DIR__ . '/../../../config.php');
require_login();

$context = context_system::instance();
require_capability('local/deanpromoodle:viewstudent', $context);

$tab = optional_param('tab', 'courses', PARAM_ALPHA);

$PAGE->set_url('/local/deanpromoodle/pages/student.php', ['tab' => $tab]);
$PAGE->set_title(get_string('studentpagetitle', 'local_deanpromoodle'));
$PAGE->set_heading(get_string('studentpagetitle', 'local_deanpromoodle'));
$PAGE->set_pagelayout('standard');
$PAGE->requires->css('/local/deanpromoodle/styles.css');

echo $OUTPUT->header();

// Вкладки
$tabs = [
    new tabobject('courses', 
        new moodle_url('/local/deanpromoodle/pages/student.php', ['tab' => 'courses']),
        get_string('courses', 'local_deanpromoodle')
    ),
    new tabobject('programs',
        new moodle_url('/local/deanpromoodle/pages/student.php', ['tab' => 'programs']),
        get_string('programs', 'local_deanpromoodle')
    ),
];
echo $OUTPUT->tabtree($tabs, $tab);

// Содержимое вкладок
switch ($tab) {
    case 'courses':
        display_courses();
        break;
    case 'programs':
        display_programs();
        break;
}

echo $OUTPUT->footer();

function display_courses() {
    global $USER, $DB;
    
    $courses = enrol_get_all_users_courses($USER->id);
    
    $table = new html_table();
    $table->head = [
        get_string('coursename', 'local_deanpromoodle'),
        get_string('grade', 'local_deanpromoodle'),
    ];
    
    foreach ($courses as $course) {
        $row = [];
        $row[] = $course->fullname;
        $row[] = get_course_grade($course->id, $USER->id);
        $table->data[] = $row;
    }
    
    echo html_writer::table($table);
}
```

## Следующие шаги

После создания страниц переходите к:
- [Этап 5: Навигация и кнопки](05-Навигация-и-кнопки.md) — интеграция в навигацию Moodle
- [Этап 6: Работа с API Moodle](06-Работа-с-API-Moodle.md) — использование Moodle API

## Полезные ссылки

- [Moodle Page API](https://docs.moodle.org/dev/Page_API)
- [Moodle Forms API](https://docs.moodle.org/dev/Form_API)
- [Moodle Output API](https://docs.moodle.org/dev/Output_API)
