# Этап 3: Работа с базой данных

## Введение

Moodle использует XMLDB для определения структуры базы данных плагинов. Это позволяет Moodle автоматически создавать и обновлять таблицы при установке и обновлении плагина.

## Что такое XMLDB?

XMLDB — это система Moodle для определения структуры базы данных через XML-файлы. Она позволяет:
- Автоматически создавать таблицы при установке
- Обновлять структуру при обновлении плагина
- Поддерживать совместимость между разными СУБД (MySQL, PostgreSQL, MariaDB)

## Структура директории db/

```
db/
├── install.xml    # Определение таблиц при установке
└── upgrade.php    # Логика обновления БД
```

## Создание install.xml

Файл `install.xml` определяет структуру таблиц, которые будут созданы при первой установке плагина.

### Базовая структура файла

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<XMLDB PATH="local/deanpromoodle/db" VERSION="20260129" COMMENT="XMLDB file for Moodle local/deanpromoodle"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../lib/xmldb/xmldb.xsd">
  <TABLES>
    <!-- Определения таблиц здесь -->
  </TABLES>
</XMLDB>
```

### Определение таблицы

Рассмотрим пример создания таблицы `local_deanpromoodle_subjects`:

```xml
<TABLE NAME="local_deanpromoodle_subjects" COMMENT="Таблица предметов">
  <FIELDS>
    <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
    <FIELD NAME="name" TYPE="char" LENGTH="255" NOTNULL="true"/>
    <FIELD NAME="code" TYPE="char" LENGTH="100" NOTNULL="false"/>
    <FIELD NAME="description" TYPE="text" NOTNULL="false"/>
    <FIELD NAME="visible" TYPE="int" LENGTH="1" NOTNULL="true" DEFAULT="1"/>
    <FIELD NAME="timemodified" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0"/>
    <FIELD NAME="timecreated" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0"/>
  </FIELDS>
  <KEYS>
    <KEY NAME="primary" TYPE="primary" FIELDS="id"/>
  </KEYS>
  <INDEXES>
    <INDEX NAME="visible" UNIQUE="false" FIELDS="visible"/>
  </INDEXES>
</TABLE>
```

### Типы полей

#### Основные типы

1. **INTEGER** — целое число
   ```xml
   <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
   ```
   - `SEQUENCE="true"` — автоинкремент
   - `LENGTH="10"` — максимальная длина

2. **CHAR** — строка фиксированной длины
   ```xml
   <FIELD NAME="name" TYPE="char" LENGTH="255" NOTNULL="true"/>
   ```

3. **TEXT** — текст неограниченной длины
   ```xml
   <FIELD NAME="description" TYPE="text" NOTNULL="false"/>
   ```

4. **NUMBER** — число с плавающей точкой
   ```xml
   <FIELD NAME="price" TYPE="number" LENGTH="10,2" NOTNULL="false"/>
   ```

5. **TIMESTAMP** — временная метка (Unix timestamp)
   ```xml
   <FIELD NAME="timecreated" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0"/>
   ```

### Ключи (KEYS)

#### Первичный ключ (Primary Key)

```xml
<KEY NAME="primary" TYPE="primary" FIELDS="id"/>
```

#### Внешний ключ (Foreign Key)

```xml
<KEY NAME="userid_fk" TYPE="foreign" FIELDS="userid" REFTABLE="user" REFFIELDS="id"/>
```

**Параметры:**
- `TYPE="foreign"` — тип ключа
- `FIELDS="userid"` — поле в текущей таблице
- `REFTABLE="user"` — ссылающаяся таблица
- `REFFIELDS="id"` — поле в ссылающейся таблице

#### Уникальный ключ (Unique Key)

```xml
<KEY NAME="userid_unique" TYPE="unique" FIELDS="userid"/>
```

### Индексы (INDEXES)

Индексы ускоряют поиск по таблице:

```xml
<INDEX NAME="visible" UNIQUE="false" FIELDS="visible"/>
<INDEX NAME="sortorder" UNIQUE="false" FIELDS="sortorder"/>
<INDEX NAME="subjectcourse" UNIQUE="true" FIELDS="subjectid, courseid"/>
```

**Параметры:**
- `UNIQUE="true"` — уникальный индекс (не допускает дубликаты)
- `UNIQUE="false"` — обычный индекс
- `FIELDS` — поля для индекса (можно несколько через запятую)

### Пример полной таблицы с связями

```xml
<TABLE NAME="local_deanpromoodle_subject_courses" COMMENT="Связь предметов с курсами">
  <FIELDS>
    <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
    <FIELD NAME="subjectid" TYPE="int" LENGTH="10" NOTNULL="true"/>
    <FIELD NAME="courseid" TYPE="int" LENGTH="10" NOTNULL="true"/>
    <FIELD NAME="sortorder" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0"/>
    <FIELD NAME="timemodified" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0"/>
    <FIELD NAME="timecreated" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0"/>
  </FIELDS>
  <KEYS>
    <KEY NAME="primary" TYPE="primary" FIELDS="id"/>
    <KEY NAME="subjectid" TYPE="foreign" FIELDS="subjectid" REFTABLE="local_deanpromoodle_subjects" REFFIELDS="id"/>
    <KEY NAME="courseid" TYPE="foreign" FIELDS="courseid" REFTABLE="course" REFFIELDS="id"/>
  </KEYS>
  <INDEXES>
    <INDEX NAME="subjectid" UNIQUE="false" FIELDS="subjectid"/>
    <INDEX NAME="courseid" UNIQUE="false" FIELDS="courseid"/>
    <INDEX NAME="subjectcourse" UNIQUE="true" FIELDS="subjectid, courseid"/>
  </INDEXES>
</TABLE>
```

## Работа с upgrade.php

Файл `upgrade.php` содержит логику обновления базы данных при обновлении плагина.

### Базовая структура функции

```php
function xmldb_local_deanpromoodle_upgrade($oldversion) {
    global $DB;
    $dbman = $DB->get_manager();
    
    // Пример 1: Добавление нового поля в существующую таблицу
    if ($oldversion < 2026013001) {
        $table = new xmldb_table('local_deanpromoodle_programs');
        $field = new xmldb_field('institution', XMLDB_TYPE_CHAR, '255', null, null, null, null, 'description');
        
        if (!$dbman->field_exists($table, $field)) {
            $dbman->add_field($table, $field);
        }
        
        upgrade_plugin_savepoint(true, 2026013001, 'local', 'deanpromoodle');
    }
    
    // Пример 2: Создание новой таблицы
    if ($oldversion < 2026013002) {
        $table = new xmldb_table('local_deanpromoodle_institutions');
        
        if (!$dbman->table_exists($table)) {
            $table->add_field('id', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, XMLDB_SEQUENCE, null);
            $table->add_field('name', XMLDB_TYPE_CHAR, '255', null, XMLDB_NOTNULL, null, null);
            $table->add_field('description', XMLDB_TYPE_TEXT, null, null, null, null, null);
            $table->add_field('visible', XMLDB_TYPE_INTEGER, '1', null, XMLDB_NOTNULL, null, '1');
            $table->add_field('timemodified', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, '0');
            $table->add_field('timecreated', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, '0');
            
            $table->add_key('primary', XMLDB_KEY_PRIMARY, ['id']);
            $table->add_index('visible', XMLDB_INDEX_NOTUNIQUE, ['visible']);
            
            $dbman->create_table($table);
        }
        
        upgrade_plugin_savepoint(true, 2026013002, 'local', 'deanpromoodle');
    }
    
    return true;
}
```

### Добавление нового поля

```php
if ($oldversion < 2026013001) {
    $table = new xmldb_table('local_deanpromoodle_programs');
    $field = new xmldb_field('institution', XMLDB_TYPE_CHAR, '255', null, null, null, null, 'description');
    
    if (!$dbman->field_exists($table, $field)) {
        $dbman->add_field($table, $field);
    }
    
    upgrade_plugin_savepoint(true, 2026013001, 'local', 'deanpromoodle');
}
```

**Параметры xmldb_field:**
1. Имя поля
2. Тип поля (`XMLDB_TYPE_CHAR`, `XMLDB_TYPE_INTEGER`, `XMLDB_TYPE_TEXT`)
3. Длина
4. Unsigned (null для CHAR/TEXT)
5. NotNull
6. Sequence
7. Default значение
8. После какого поля добавить

### Создание новой таблицы

```php
if ($oldversion < 2026013002) {
    $table = new xmldb_table('local_deanpromoodle_institutions');
    
    if (!$dbman->table_exists($table)) {
        // Определение полей
        $table->add_field('id', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, XMLDB_SEQUENCE, null);
        $table->add_field('name', XMLDB_TYPE_CHAR, '255', null, XMLDB_NOTNULL, null, null);
        $table->add_field('description', XMLDB_TYPE_TEXT, null, null, null, null, null);
        $table->add_field('visible', XMLDB_TYPE_INTEGER, '1', null, XMLDB_NOTNULL, null, '1');
        $table->add_field('timemodified', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, '0');
        $table->add_field('timecreated', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, '0');
        
        // Определение ключей
        $table->add_key('primary', XMLDB_KEY_PRIMARY, ['id']);
        
        // Определение индексов
        $table->add_index('visible', XMLDB_INDEX_NOTUNIQUE, ['visible']);
        
        // Создание таблицы
        $dbman->create_table($table);
    }
    
    upgrade_plugin_savepoint(true, 2026013002, 'local', 'deanpromoodle');
}
```

### Изменение существующего поля

```php
if ($oldversion < 2026013003) {
    $table = new xmldb_table('local_deanpromoodle_subjects');
    $field = new xmldb_field('name', XMLDB_TYPE_CHAR, '500', null, XMLDB_NOTNULL, null, null);
    
    if ($dbman->field_exists($table, $field)) {
        $dbman->change_field_type($table, $field);
    }
    
    upgrade_plugin_savepoint(true, 2026013003, 'local', 'deanpromoodle');
}
```

### Удаление поля

```php
if ($oldversion < 2026013004) {
    $table = new xmldb_table('local_deanpromoodle_programs');
    $field = new xmldb_field('old_field');
    
    if ($dbman->field_exists($table, $field)) {
        $dbman->drop_field($table, $field);
    }
    
    upgrade_plugin_savepoint(true, 2026013004, 'local', 'deanpromoodle');
}
```

### Добавление индекса

```php
if ($oldversion < 2026013005) {
    $table = new xmldb_table('local_deanpromoodle_subjects');
    $index = new xmldb_index('name', XMLDB_INDEX_NOTUNIQUE, ['name']);
    
    if (!$dbman->index_exists($table, $index)) {
        $dbman->add_index($table, $index);
    }
    
    upgrade_plugin_savepoint(true, 2026013005, 'local', 'deanpromoodle');
}
```

## Работа с данными через Moodle API

### Вставка записи

```php
global $DB;

$record = new stdClass();
$record->name = 'Название предмета';
$record->code = 'SUB001';
$record->description = 'Описание предмета';
$record->visible = 1;
$record->timecreated = time();
$record->timemodified = time();

$id = $DB->insert_record('local_deanpromoodle_subjects', $record);
```

### Обновление записи

```php
global $DB;

$record = new stdClass();
$record->id = 1;
$record->name = 'Новое название';
$record->timemodified = time();

$DB->update_record('local_deanpromoodle_subjects', $record);
```

### Получение одной записи

```php
global $DB;

// По ID
$subject = $DB->get_record('local_deanpromoodle_subjects', ['id' => 1]);

// По условию
$subject = $DB->get_record('local_deanpromoodle_subjects', ['code' => 'SUB001']);
```

### Получение нескольких записей

```php
global $DB;

// Все записи
$subjects = $DB->get_records('local_deanpromoodle_subjects');

// С условием
$subjects = $DB->get_records('local_deanpromoodle_subjects', ['visible' => 1]);

// С сортировкой
$subjects = $DB->get_records('local_deanpromoodle_subjects', ['visible' => 1], 'sortorder ASC');
```

### Выполнение SQL запросов

```php
global $DB;

// Простой запрос
$sql = "SELECT * FROM {local_deanpromoodle_subjects} WHERE visible = ?";
$subjects = $DB->get_records_sql($sql, [1]);

// С параметрами
$sql = "SELECT * FROM {local_deanpromoodle_subjects} WHERE name LIKE ? AND visible = ?";
$subjects = $DB->get_records_sql($sql, ['%название%', 1]);
```

**Важно:** Используйте `{table_name}` вместо `mdl_table_name` — Moodle автоматически подставит префикс.

### Проверка существования записи

```php
global $DB;

// По условию
if ($DB->record_exists('local_deanpromoodle_subjects', ['code' => 'SUB001'])) {
    // Запись существует
}

// По ID
if ($DB->record_exists('local_deanpromoodle_subjects', ['id' => 1])) {
    // Запись существует
}
```

### Удаление записи

```php
global $DB;

$DB->delete_records('local_deanpromoodle_subjects', ['id' => 1]);
```

## Важные моменты

### Именование таблиц

- Все таблицы плагина должны начинаться с префикса `local_deanpromoodle_`
- Используйте понятные имена: `subjects`, `programs`, `student_info`
- Избегайте сокращений, если они не очевидны

### Стандартные поля

Рекомендуется добавлять в каждую таблицу:
- `id` — первичный ключ (автоинкремент)
- `timecreated` — время создания записи
- `timemodified` — время последнего изменения

### Внешние ключи

При создании внешних ключей:
- Используйте существующие таблицы Moodle: `user`, `course`, `cohort`
- Указывайте правильные типы ключей
- Не создавайте индексы для внешних ключей вручную (Moodle делает это автоматически)

### Обновление версии

После каждого изменения в `upgrade.php`:
1. Обновите версию в `version.php`
2. Добавьте проверку версии в `upgrade.php`
3. Вызовите `upgrade_plugin_savepoint()` в конце блока обновления

## Проверка структуры БД

### Чек-лист

- [ ] Все таблицы определены в `install.xml`
- [ ] Все поля имеют правильные типы и длины
- [ ] Определены первичные ключи для всех таблиц
- [ ] Внешние ключи ссылаются на существующие таблицы
- [ ] Добавлены необходимые индексы
- [ ] Логика обновления добавлена в `upgrade.php`
- [ ] Версия плагина обновлена в `version.php`

## Частые ошибки

### Ошибка 1: "Table already exists"

**Причина**: Таблица уже существует в базе данных

**Решение**: 
- Проверьте, не создавали ли вы таблицу вручную
- Удалите таблицу из БД и выполните обновление заново

### Ошибка 2: "Foreign key constraint fails"

**Причина**: Попытка создать внешний ключ на несуществующую таблицу или поле

**Решение**: 
- Убедитесь, что ссылающаяся таблица существует
- Проверьте правильность имени поля в `REFFIELDS`

### Ошибка 3: "Key collides with index"

**Причина**: Попытка создать индекс для поля, которое уже является частью внешнего ключа

**Решение**: 
- Удалите явное определение индекса для внешнего ключа
- Moodle автоматически создает индекс для внешних ключей

### Ошибка 4: "Field doesn't exist"

**Причина**: Попытка изменить или удалить несуществующее поле

**Решение**: 
- Добавьте проверку `field_exists()` перед операцией
- Убедитесь, что имя поля указано правильно

## Следующие шаги

После создания структуры базы данных переходите к:
- [Этап 4: Создание страниц](04-Создание-страниц.md) — разработка страниц плагина
- [Этап 6: Работа с API Moodle](06-Работа-с-API-Moodle.md) — использование Moodle API для работы с данными

## Полезные ссылки

- [Moodle XMLDB Documentation](https://docs.moodle.org/dev/XMLDB)
- [Moodle Database API](https://docs.moodle.org/dev/Data_manipulation_API)
- [Moodle Upgrade API](https://docs.moodle.org/dev/Upgrade_API)
