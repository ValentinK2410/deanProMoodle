# Этап 5: Навигация и кнопки

## Введение

Интеграция плагина в навигацию Moodle позволяет пользователям легко находить и использовать функции плагина. Это можно сделать через стандартные хуки Moodle и JavaScript для добавления кнопок в интерфейс.

## Расширение навигации Moodle

### Функция extend_navigation

Moodle автоматически вызывает функцию `local_плагин_extend_navigation()` для расширения навигации.

```php
/**
 * Extend navigation to add plugin pages.
 *
 * @param global_navigation $navigation The navigation object
 */
function local_deanpromoodle_extend_navigation(global_navigation $navigation) {
    global $PAGE, $USER;

    // Check if user is logged in
    if (!isloggedin() || isguestuser()) {
        return;
    }

    // Get the main navigation node
    $mainnode = $navigation->find('home', global_navigation::TYPE_ROOTNODE);
    
    if (!$mainnode) {
        return;
    }

    // Add Student Page if user has capability
    if (has_capability('local/deanpromoodle:viewstudent', context_system::instance())) {
        $studenturl = new moodle_url('/local/deanpromoodle/pages/student.php');
        $mainnode->add(
            get_string('studentpage', 'local_deanpromoodle'),
            $studenturl,
            navigation_node::TYPE_CUSTOM,
            null,
            'deanpromoodle_student',
            new pix_icon('i/user', '')
        );
    }
}
```

### Параметры метода add()

```php
$mainnode->add(
    $text,              // Текст пункта меню
    $action,            // URL (moodle_url объект)
    $type,              // Тип узла (TYPE_CUSTOM, TYPE_SETTING)
    $shorttext,         // Короткий текст (null)
    $key,               // Уникальный ключ
    $icon               // Иконка (pix_icon объект)
);
```

### Типы узлов навигации

- `navigation_node::TYPE_CUSTOM` — пользовательский узел
- `navigation_node::TYPE_SETTING` — настройка
- `navigation_node::TYPE_CONTAINER` — контейнер
- `navigation_node::TYPE_COURSE` — курс

## Добавление кнопок через хуки

### Хук before_footer

Moodle позволяет добавлять код перед выводом подвала страницы через хук `before_footer`.

**Регистрация хука в `lib.php`:**

```php
// Хук автоматически вызывается Moodle, если функция существует
// Имя функции должно быть: local_плагин_before_footer()
function local_deanpromoodle_before_footer() {
    global $PAGE, $USER;
    
    // Проверка доступности $PAGE
    if (!isset($PAGE) || !is_object($PAGE)) {
        return;
    }
    
    // Проверка типа страницы (не добавляем на страницах входа)
    $pagetype = $PAGE->pagetype;
    if (strpos($pagetype, 'login') !== false || 
        strpos($pagetype, 'signup') !== false || 
        strpos($pagetype, 'auth') !== false) {
        return;
    }
    
    // Проверка авторизации
    if (!isloggedin() || isguestuser()) {
        return;
    }
    
    // Добавление кнопок через JavaScript
    add_buttons_to_header();
}
```

### Определение ролей пользователя

```php
function local_deanpromoodle_before_footer() {
    global $USER, $DB;
    
    $context = context_system::instance();
    
    // Проверка, является ли пользователь администратором
    $isadmin = has_capability('moodle/site:config', $context) || 
               has_capability('local/deanpromoodle:viewadmin', $context);
    
    // Проверка, является ли пользователь преподавателем
    $isteacher = false;
    if (!$isadmin) {
        // Проверка роли teacher (id = 3) в любом курсе
        $sql = "SELECT 1 FROM {role_assignments} ra
                JOIN {context} ctx ON ctx.id = ra.contextid
                WHERE ra.userid = ?
                AND ra.roleid = 3
                AND ctx.contextlevel = 50
                LIMIT 1";
        
        // record_exists_sql() возвращает:
        // - true, если найдена хотя бы одна запись, соответствующая условию
        // - false, если записей не найдено
        $isteacher = $DB->record_exists_sql($sql, [$USER->id]);
    }
    
    // Проверка, является ли пользователь студентом
    $isstudent = false;
    if (!$isadmin && !$isteacher) {
        $sql = "SELECT 1 FROM {role_assignments} ra
                JOIN {context} ctx ON ctx.id = ra.contextid
                WHERE ra.userid = ?
                AND ra.roleid = 5
                AND ctx.contextlevel = 50
                LIMIT 1";
        
        // record_exists_sql() возвращает:
        // - true, если найдена хотя бы одна запись, соответствующая условию
        // - false, если записей не найдено
        $isstudent = $DB->record_exists_sql($sql, [$USER->id]);
    }
    
    // Определение URL для кнопок
    $lkurl = null;
    $teacherurl = null;
    
    if ($isadmin || $isstudent) {
        $lkurl = new moodle_url('/local/deanpromoodle/pages/student.php');
    }
    
    if ($isadmin || $isteacher) {
        $teacherurl = new moodle_url('/local/deanpromoodle/pages/teacher.php');
    }
    
    // Добавление кнопок
    if ($lkurl || $teacherurl) {
        add_buttons_to_header($lkurl, $teacherurl);
    }
}
```

## Добавление кнопок через JavaScript

### Поиск контейнера для кнопок

```javascript
function addButtonsToHeader(lkUrl, teacherUrl) {
    // Поиск существующего контейнера SSO кнопок
    var ssoContainer = document.querySelector('.moodle-sso-buttons-container');
    
    // Если контейнер не найден, создаем новый
    if (!ssoContainer) {
        ssoContainer = createDeanProMoodleContainer();
    }
    
    // Добавление кнопок в контейнер
    if (lkUrl) {
        addButton(ssoContainer, 'Деканат', lkUrl, 'lk-button');
    }
    
    if (teacherUrl) {
        addButton(ssoContainer, 'Преподаватель', teacherUrl, 'teacher-button');
    }
}
```

### Создание независимого контейнера

```javascript
function createDeanProMoodleContainer() {
    // Поиск места для вставки контейнера
    var targetElement = null;
    
    // Приоритет 1: topBar
    targetElement = document.querySelector('.topBar, .top-bar, #top-bar');
    
    // Приоритет 2: userMenu
    if (!targetElement) {
        var userMenu = document.querySelector('.userMenu, .user-menu, [data-region="usermenu"]');
        if (userMenu && userMenu.parentElement) {
            targetElement = userMenu.parentElement;
        }
    }
    
    // Приоритет 3: navBar
    if (!targetElement) {
        targetElement = document.querySelector('.navBar, .nav-bar, nav, [role="navigation"]');
    }
    
    // Приоритет 4: header
    if (!targetElement) {
        targetElement = document.querySelector('header, .header, #page-header');
    }
    
    // Приоритет 5: body
    if (!targetElement) {
        targetElement = document.body;
    }
    
    // Создание контейнера
    var container = document.createElement('div');
    container.className = 'dean-pro-moodle';
    container.style.cssText = 'display: inline-flex; gap: 10px; align-items: center; margin-left: 5px; margin-right: 10px;';
    
    // Вставка контейнера
    if (targetElement) {
        if (targetElement === document.body) {
            targetElement.insertBefore(container, targetElement.firstChild);
        } else {
            targetElement.appendChild(container);
        }
    }
    
    return container;
}
```

### Создание кнопки

```javascript
function addButton(container, text, url, className) {
    // Проверка, не существует ли уже такая кнопка
    var existingButton = container.querySelector('.' + className);
    if (existingButton) {
        return;
    }
    
    // Создание элемента кнопки
    var button = document.createElement('a');
    button.href = url;
    button.textContent = text;
    button.className = className;
    button.style.cssText = 'display: inline-block; padding: 8px 16px; ' +
                          'background-color: #007bff; color: white; ' +
                          'text-decoration: none; border-radius: 4px; ' +
                          'transition: background-color 0.3s;';
    
    // Обработчик наведения
    button.onmouseover = function() {
        this.style.backgroundColor = '#0056b3';
    };
    button.onmouseout = function() {
        this.style.backgroundColor = '#007bff';
    };
    
    // Добавление кнопки в контейнер
    container.appendChild(button);
}
```

## Добавление иконок

### Использование Font Awesome

```javascript
function addButtonWithIcon(container, text, url, iconClass) {
    var button = document.createElement('a');
    button.href = url;
    button.className = 'deanpromoodle-button';
    
    // Создание иконки
    var icon = document.createElement('i');
    icon.className = 'fa ' + iconClass;
    icon.style.cssText = 'margin-right: 5px;';
    
    // Создание текста
    var textSpan = document.createElement('span');
    textSpan.textContent = text;
    
    // Сборка кнопки
    button.appendChild(icon);
    button.appendChild(textSpan);
    
    container.appendChild(button);
}
```

### Использование SVG иконок

```javascript
function addTelegramButton(container) {
    var button = document.createElement('a');
    button.href = 'https://t.me/+I9rjz2wfEpI4NjIy';
    button.target = '_blank';
    button.className = 'telegram-button';
    button.title = 'Техподдержка';
    
    // SVG иконка Telegram
    var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', '20');
    svg.setAttribute('height', '20');
    svg.setAttribute('viewBox', '0 0 24 24');
    svg.style.cssText = 'fill: currentColor;';
    
    var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', 'M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.161c-.169 0-.37.02-.599.06-.229.04-.47.1-.722.18-.252.08-.515.19-.789.33-.274.14-.56.31-.857.51-.297.2-.605.43-.923.69-.319.26-.648.55-.987.87-.34.32-.69.67-1.05 1.05-.36.38-.73.78-1.11 1.2-.38.42-.77.85-1.17 1.29-.4.44-.81.88-1.23 1.32-.42.44-.85.87-1.29 1.29-.44.42-.88.83-1.32 1.23-.44.4-.88.8-1.32 1.17-.44.37-.88.73-1.32 1.08-.44.35-.87.68-1.29 1-.42.32-.83.62-1.23.9-.4.28-.79.53-1.17.75-.38.22-.75.41-1.11.57-.36.16-.71.29-1.05.39-.34.1-.67.17-.99.21-.32.04-.63.06-.93.06-.3 0-.59-.02-.87-.06-.28-.04-.55-.11-.81-.21-.26-.1-.51-.23-.75-.39-.24-.16-.47-.35-.69-.57-.22-.22-.43-.47-.63-.75-.2-.28-.38-.59-.54-.93-.16-.34-.3-.71-.42-1.11-.12-.4-.22-.83-.3-1.29-.08-.46-.14-.95-.18-1.47-.04-.52-.06-1.07-.06-1.65 0-.58.02-1.13.06-1.65.04-.52.1-1.01.18-1.47.08-.46.18-.89.3-1.29.12-.4.26-.77.42-1.11.16-.34.34-.65.54-.93.2-.28.41-.53.63-.75.22-.22.45-.41.69-.57.24-.16.49-.29.75-.39.26-.1.53-.17.81-.21.28-.04.57-.06.87-.06.3 0 .61.02.93.06.32.04.65.11.99.21.34.1.69.23 1.05.39.36.16.73.35 1.11.57.38.22.77.47 1.17.75.4.28.81.58 1.23.9.42.32.85.65 1.29 1 .44.35.88.71 1.32 1.08.44.37.88.77 1.32 1.17.44.4.88.8 1.32 1.23.44.42.88.85 1.32 1.29.42.44.83.88 1.23 1.32.4.44.79.87 1.17 1.29.38.42.75.82 1.11 1.2.36.38.71.73 1.05 1.05.34.32.67.61.987.87.319.26.626.49.923.69.297.2.583.37.857.51.274.14.537.25.789.33.252.08.493.14.722.18.229.04.43.06.599.06.169 0 .37-.02.599-.06.229-.04.47-.1.722-.18.252-.08.515-.19.789-.33.274-.14.56-.31.857-.51.297-.2.605-.43.923-.69.319-.26.648-.55.987-.87.34-.32.69-.67 1.05-1.05.36-.38.73-.78 1.11-1.2.38-.42.77-.85 1.17-1.29.4-.44.81-.88 1.23-1.32.42-.44.85-.87 1.29-1.29.44-.42.88-.83 1.32-1.23.44-.4.88-.8 1.32-1.17.44-.37.88-.73 1.32-1.08.44-.35.87-.68 1.29-1 .42-.32.83-.62 1.23-.9.4-.28.79-.53 1.17-.75.38-.22.75-.41 1.11-.57.36-.16.71-.29 1.05-.39.34-.1.67-.17.99-.21.32-.04.63-.06.93-.06z');
    
    svg.appendChild(path);
    button.appendChild(svg);
    
    container.appendChild(button);
}
```

## Добавление Cookie Consent Banner

### Создание баннера согласия на cookies

```javascript
function addCookieConsentBanner() {
    // Проверка, не показывали ли уже баннер
    if (localStorage.getItem('deanpromoodle_cookie_consent') === 'accepted' ||
        localStorage.getItem('deanpromoodle_cookie_consent') === 'declined') {
        return;
    }
    
    // Создание баннера
    var banner = document.createElement('div');
    banner.id = 'deanpromoodle-cookie-banner';
    banner.style.cssText = 'position: fixed; bottom: 0; left: 0; right: 0; ' +
                          'background-color: #2c3e50; color: white; ' +
                          'padding: 20px; z-index: 10000; ' +
                          'box-shadow: 0 -2px 10px rgba(0,0,0,0.2); ' +
                          'display: flex; align-items: center; ' +
                          'justify-content: space-between; flex-wrap: wrap; gap: 15px;';
    
    // Текст баннера
    var text = document.createElement('div');
    text.textContent = 'Мы используем cookies для улучшения работы сайта. ' +
                      'Продолжая использовать сайт, вы соглашаетесь с использованием cookies.';
    text.style.cssText = 'flex: 1; min-width: 250px;';
    
    // Кнопки
    var buttonsContainer = document.createElement('div');
    buttonsContainer.style.cssText = 'display: flex; gap: 10px;';
    
    // Кнопка "Принять"
    var acceptButton = document.createElement('button');
    acceptButton.textContent = 'Принять';
    acceptButton.style.cssText = 'padding: 10px 20px; background-color: #27ae60; ' +
                                 'color: white; border: none; border-radius: 4px; ' +
                                 'cursor: pointer; font-weight: bold;';
    acceptButton.onclick = function() {
        localStorage.setItem('deanpromoodle_cookie_consent', 'accepted');
        setCookie('deanpromoodle_cookie_consent', 'accepted', 365);
        banner.remove();
    };
    
    // Кнопка "Отклонить"
    var declineButton = document.createElement('button');
    declineButton.textContent = 'Отклонить';
    declineButton.style.cssText = 'padding: 10px 20px; background-color: #e74c3c; ' +
                                  'color: white; border: none; border-radius: 4px; ' +
                                  'cursor: pointer; font-weight: bold;';
    declineButton.onclick = function() {
        localStorage.setItem('deanpromoodle_cookie_consent', 'declined');
        setCookie('deanpromoodle_cookie_consent', 'declined', 365);
        banner.remove();
    };
    
    buttonsContainer.appendChild(acceptButton);
    buttonsContainer.appendChild(declineButton);
    
    banner.appendChild(text);
    banner.appendChild(buttonsContainer);
    
    // Добавление баннера на страницу
    if (document.body) {
        document.body.appendChild(banner);
    }
}

function setCookie(name, value, days) {
    var expires = '';
    if (days) {
        var date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = '; expires=' + date.toUTCString();
    }
    document.cookie = name + '=' + (value || '') + expires + '; path=/';
}
```

## Обработка ошибок

### Безопасное выполнение JavaScript

```javascript
function addButtonsToHeader() {
    try {
        // Основной код
        var container = document.querySelector('.moodle-sso-buttons-container');
        if (!container) {
            container = createDeanProMoodleContainer();
        }
        // ... остальной код
    } catch (error) {
        console.error('Error adding buttons:', error);
        // Не прерываем выполнение страницы при ошибке
    }
}
```

### Проверка готовности DOM

```javascript
function addButtonsWhenReady() {
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', addButtonsToHeader);
    } else {
        addButtonsToHeader();
    }
}
```

## Следующие шаги

После добавления навигации и кнопок переходите к:
- [Этап 6: Работа с API Moodle](06-Работа-с-API-Moodle.md) — использование Moodle API
- [Этап 7: Стилизация и UI](07-Стилизация-и-UI.md) — улучшение внешнего вида

## Полезные ссылки

- [Moodle Navigation API](https://docs.moodle.org/dev/Navigation_API)
- [Moodle Hooks](https://docs.moodle.org/dev/Hooks)
- [Moodle JavaScript API](https://docs.moodle.org/dev/JavaScript)
